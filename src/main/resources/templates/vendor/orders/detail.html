<!DOCTYPE html>
<html
     xmlns:th="http://www.thymeleaf.org"
     xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
>
     <head th:replace="~{fragments/head :: head}">
          <title>Order Detail - Badminton Marketplace</title>
     </head>
     <body>
          <style>
               table.order-items td {
                    vertical-align: middle;
                    padding: 10px 8px;
               }
               .timeline {
                    position: relative;
                    padding-left: 40px;
               }
               .timeline-item {
                    position: relative;
                    padding-bottom: 30px;
               }
               .timeline-item:last-child {
                    padding-bottom: 0;
               }
               .timeline-marker {
                    position: absolute;
                    left: -40px;
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    border: 3px solid #fff;
                    box-shadow: 0 0 0 2px #dee2e6;
               }
               .timeline-item::after {
                    content: '';
                    position: absolute;
                    left: -31px;
                    top: 20px;
                    width: 2px;
                    height: calc(100% + 10px);
                    background-color: #dee2e6;
               }
               .timeline-item:last-child::after {
                    display: none;
               }
               .timeline-content {
                    background-color: #f8f9fa;
                    padding: 15px;
                    border-radius: 8px;
                    border-left: 3px solid #dee2e6;
               }
          </style>
          <div th:replace="~{fragments/header :: header}"></div>

          <div class="container-fluid mt-4">
               <div class="row">
                    <!-- Sidebar -->
                    <div th:replace="~{vendor/fragments/sidebar :: sidebar('orders')}"></div>

                    <!-- Main content -->
                    <div class="col-md-10">
                         <div
                              th:if="${success}"
                              class="alert alert-success alert-dismissible fade show"
                              role="alert"
                         >
                              <i class="fas fa-check-circle"></i> <span th:text="${success}"></span>
                              <button
                                   type="button"
                                   class="btn-close"
                                   data-bs-dismiss="alert"
                              ></button>
                         </div>

                         <div
                              th:if="${error}"
                              class="alert alert-danger alert-dismissible fade show"
                              role="alert"
                         >
                              <i class="fas fa-exclamation-circle"></i>
                              <span th:text="${error}"></span>
                              <button
                                   type="button"
                                   class="btn-close"
                                   data-bs-dismiss="alert"
                              ></button>
                         </div>

                         <div class="d-flex justify-content-between align-items-center mb-4">
                              <h2>
                                   <i class="fas fa-receipt"></i> Chi tiết đơn hàng
                                   <span th:text="${order != null ? order.orderId : ''}"
                                        >#ORD001</span
                                   >
                              </h2>
                              <a th:href="@{/vendor/orders}" class="btn btn-secondary">
                                   <i class="fas fa-arrow-left"></i> Quay lại
                              </a>
                         </div>

                         <!-- Order Status & Actions -->
                         <div class="card mb-4" th:if="${order != null}">
                              <div
                                   class="card-header d-flex justify-content-between align-items-center"
                              >
                                   <h5 class="mb-0">Trạng thái đơn hàng</h5>
                                   <div>
                                        <span
                                             th:if="${order.status != null}"
                                             th:switch="${order.status.name()}"
                                        >
                                             <span
                                                  th:case="'NOT_PROCESSED'"
                                                  class="badge bg-warning fs-6"
                                                  >Chờ xử lý</span
                                             >
                                             <span th:case="'PROCESSING'" class="badge bg-info fs-6"
                                                  >Đang xử lý</span
                                             >
                                             <span th:case="'SHIPPED'" class="badge bg-primary fs-6"
                                                  >Đang giao</span
                                             >
                                             <span th:case="'AWAITING_CONFIRMATION'" class="badge bg-warning fs-6"
                                                  >Chờ xác nhận</span
                                             >
                                             <span
                                                  th:case="'DELIVERED'"
                                                  class="badge bg-success fs-6"
                                                  >Đã giao</span
                                             >
                                             <span
                                                  th:case="'CANCELLED'"
                                                  class="badge bg-danger fs-6"
                                                  >Đã hủy</span
                                             >
                                             <span
                                                  th:case="'RETURNED'"
                                                  class="badge bg-secondary fs-6"
                                                  >Trả hàng</span
                                             >
                                        </span>
                                   </div>
                              </div>
                              <div class="card-body">
                                   <div class="btn-group" role="group">
                                        <!-- Vendor may only confirm or cancel when order is NEW (NOT_PROCESSED).
                                 Shipping and delivery updates are handled by the shipper. -->
                                        <form
                                             th:if="${order.status != null && order.status.name() == 'NOT_PROCESSED'}"
                                             th:action="@{/vendor/orders/{id}/confirm(id=${order.orderId})}"
                                             method="post"
                                             style="display: inline"
                                             onsubmit="return confirm('Xác nhận đơn hàng này? Hàng sẽ được trừ khỏi kho.');"
                                        >
                                             <button type="submit" class="btn btn-success">
                                                  <i class="fas fa-check"></i> Xác nhận đơn hàng
                                             </button>
                                        </form>

                                        <button
                                             th:if="${order.status != null && order.status.name() == 'NOT_PROCESSED'}"
                                             type="button"
                                             class="btn btn-danger"
                                             data-bs-toggle="modal"
                                             data-bs-target="#cancelModal"
                                        >
                                             <i class="fas fa-times"></i> Hủy đơn
                                        </button>
                                   </div>

                                   <div class="mt-3">
                                        <small class="text-muted">
                                             Ngày đặt:
                                             <span
                                                  th:text="${order.orderDate != null ? #temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm') : '-'}"
                                                  >01/01/2024</span
                                             >
                                        </small>
                                   </div>
                              </div>
                         </div>

                         <div class="row" th:if="${order != null}">
                              <!-- Customer Info -->
                              <div class="col-md-6">
                                   <div class="card mb-4">
                                        <div class="card-header">
                                             <h5>
                                                  <i class="fas fa-user"></i> Thông tin khách hàng
                                             </h5>
                                        </div>
                                        <div class="card-body">
                                             <div class="d-flex align-items-start mb-3">
                                                  <img 
                                                       th:src="${order.userAvatar != null ? order.userAvatar : 'https://via.placeholder.com/80'}" 
                                                       alt="Avatar" 
                                                       class="rounded-circle me-3"
                                                       style="width: 80px; height: 80px; object-fit: cover;"
                                                  />
                                                  <div class="flex-grow-1">
                                                       <h6 class="mb-1" th:text="${order.customerName ?: 'N/A'}">Customer Name</h6>
                                                       <p class="text-muted mb-1">
                                                            <i class="fas fa-envelope me-1"></i>
                                                            <span th:text="${order.userEmail ?: 'N/A'}">email@example.com</span>
                                                       </p>
                                                       <p class="text-muted mb-0">
                                                            <i class="fas fa-phone me-1"></i>
                                                            <span th:text="${order.userPhone ?: 'N/A'}">0123456789</span>
                                                       </p>
                                                  </div>
                                             </div>
                                             <div class="alert alert-light mb-0">
                                                  <strong><i class="fas fa-map-marker-alt me-2"></i>Địa chỉ giao hàng:</strong><br />
                                                  <span th:text="${order.address ?: 'N/A'}">Address</span>
                                             </div>
                                        </div>
                                   </div>
                              </div>

                              <!-- Payment & Shipping Info -->
                              <div class="col-md-6">
                                   <div class="card mb-4">
                                        <div class="card-header">
                                             <h5>
                                                  <i class="fas fa-credit-card"></i> Thanh toán &
                                                  Giao hàng
                                             </h5>
                                        </div>
                                        <div class="card-body">
                                             <p>
                                                  <strong>Phương thức thanh toán:</strong>
                                                  <span th:text="${order.paymentMethod ?: 'COD'}"
                                                       >COD</span
                                                  >
                                             </p>
                                             <p>
                                                  <strong>Trạng thái thanh toán:</strong>
                                                  <span
                                                       th:if="${order.isPaidBefore == true}"
                                                       class="badge bg-success"
                                                       >Đã thanh toán</span
                                                  >
                                                  <span
                                                       th:unless="${order.isPaidBefore == true}"
                                                       class="badge bg-warning"
                                                       >Chờ thanh toán</span
                                                  >
                                             </p>
                                             <p
                                                  th:if="${order.shippingProviderName != null && !#strings.isEmpty(order.shippingProviderName)}"
                                             >
                                                  <strong>Đơn vị vận chuyển:</strong>
                                                  <span th:text="${order.shippingProviderName}"
                                                       >Provider</span
                                                  >
                                             </p>
                                             <p
                                                  th:if="${order.shipmentId != null && !#strings.isEmpty(order.shipmentId)}"
                                             >
                                                  <strong>Mã vận đơn:</strong>
                                                  <span th:text="${order.shipmentId}"
                                                       >TRACK123</span
                                                  >
                                             </p>
                                        </div>
                                   </div>
                              </div>
                         </div>
                         
                         <!-- Shipper Info Card -->
                         <div th:if="${order.shipperName != null}" class="card mb-4">
                              <div class="card-header">
                                   <h5><i class="fas fa-shipping-fast"></i> Thông tin người giao hàng</h5>
                              </div>
                              <div class="card-body">
                                   <div class="d-flex align-items-start">
                                        <img 
                                             th:src="${order.shipperAvatar != null ? order.shipperAvatar : 'https://via.placeholder.com/60'}" 
                                             alt="Shipper Avatar" 
                                             class="rounded-circle me-3"
                                             style="width: 60px; height: 60px; object-fit: cover;"
                                        />
                                        <div>
                                             <h6 class="mb-1" th:text="${order.shipperName}">Shipper Name</h6>
                                             <p class="text-muted mb-1" th:if="${order.shipperPhone != null}">
                                                  <i class="fas fa-phone me-1"></i>
                                                  <span th:text="${order.shipperPhone}">0123456789</span>
                                             </p>
                                             <p class="text-muted mb-1" th:if="${order.assignedAt != null}">
                                                  <i class="fas fa-clock me-1"></i>
                                                  Nhận đơn: <span th:text="${#temporals.format(order.assignedAt, 'dd/MM/yyyy HH:mm')}"></span>
                                             </p>
                                             <p class="text-muted mb-0" th:if="${order.deliveredAt != null}">
                                                  <i class="fas fa-check-circle me-1 text-success"></i>
                                                  Giao hàng: <span th:text="${#temporals.format(order.deliveredAt, 'dd/MM/yyyy HH:mm')}"></span>
                                             </p>
                                        </div>
                                   </div>
                              </div>
                         </div>
                         
                         <!-- Delivery Proof Image -->
                         <div
                              th:if="${order.deliveryImageUrl != null}"
                              class="card mb-4"
                         >
                              <div class="card-header">
                                   <h5><i class="fas fa-camera"></i> Ảnh giao hàng</h5>
                              </div>
                              <div class="card-body text-center">
                                   <img
                                        th:src="${order.deliveryImageUrl}"
                                        alt="Ảnh giao hàng"
                                        class="img-fluid rounded border"
                                        style="max-height: 350px; object-fit: contain"
                                   />

                                   <div class="mt-2">
                                        <a
                                             th:href="${order.deliveryImageUrl}"
                                             target="_blank"
                                             class="btn btn-sm btn-outline-primary"
                                        >
                                             <i class="fas fa-external-link-alt"></i> Xem ảnh lớn
                                        </a>
                                   </div>
                              </div>
                         </div>

                         <!-- Order Timeline -->
                         <div class="card mb-4" th:if="${order != null}">
                              <div class="card-header">
                                   <h5><i class="fas fa-history"></i> Lịch sử đơn hàng</h5>
                              </div>
                              <div class="card-body">
                                   <div class="timeline">
                                        <!-- Order Created -->
                                        <div class="timeline-item">
                                             <div class="timeline-marker bg-secondary"></div>
                                             <div class="timeline-content">
                                                  <h6 class="mb-1"><i class="fas fa-plus-circle me-2"></i>Đơn hàng được tạo</h6>
                                                  <p class="text-muted mb-0" th:if="${order.createdAt != null}">
                                                       <small th:text="${#temporals.format(order.createdAt, 'dd/MM/yyyy HH:mm')}"></small>
                                                  </p>
                                             </div>
                                        </div>
                                        
                                        <!-- Order Confirmed (PROCESSING) -->
                                        <div class="timeline-item" th:if="${order.status.name() == 'PROCESSING' || order.status.name() == 'SHIPPED' || order.status.name() == 'AWAITING_CONFIRMATION' || order.status.name() == 'DELIVERED'}">
                                             <div class="timeline-marker bg-info"></div>
                                             <div class="timeline-content">
                                                  <h6 class="mb-1"><i class="fas fa-check me-2"></i>Vendor xác nhận đơn hàng</h6>
                                                  <p class="text-muted mb-0">
                                                       <small>Đơn hàng đã được xác nhận và chuẩn bị hàng</small>
                                                  </p>
                                             </div>
                                        </div>
                                        
                                        <!-- Assigned to Shipper -->
                                        <div class="timeline-item" th:if="${order.assignedAt != null}">
                                             <div class="timeline-marker bg-primary"></div>
                                             <div class="timeline-content">
                                                  <h6 class="mb-1"><i class="fas fa-truck me-2"></i>Shipper nhận đơn</h6>
                                                  <p class="text-muted mb-1" th:if="${order.shipperName != null}">
                                                       <small>Shipper: <span th:text="${order.shipperName}"></span></small>
                                                  </p>
                                                  <p class="text-muted mb-0">
                                                       <small th:text="${#temporals.format(order.assignedAt, 'dd/MM/yyyy HH:mm')}"></small>
                                                  </p>
                                             </div>
                                        </div>
                                        
                                        <!-- Delivery Completed by Shipper -->
                                        <div class="timeline-item" th:if="${order.deliveredAt != null}">
                                             <div class="timeline-marker bg-warning"></div>
                                             <div class="timeline-content">
                                                  <h6 class="mb-1"><i class="fas fa-box me-2"></i>Shipper xác nhận giao hàng</h6>
                                                  <p class="text-muted mb-1">
                                                       <small>Đã giao hàng và upload ảnh chứng nhận</small>
                                                  </p>
                                                  <p class="text-muted mb-0">
                                                       <small th:text="${#temporals.format(order.deliveredAt, 'dd/MM/yyyy HH:mm')}"></small>
                                                  </p>
                                             </div>
                                        </div>
                                        
                                        <!-- User Confirmed Receipt -->
                                        <div class="timeline-item" th:if="${order.confirmedByUserAt != null}">
                                             <div class="timeline-marker bg-success"></div>
                                             <div class="timeline-content">
                                                  <h6 class="mb-1"><i class="fas fa-check-double me-2"></i>Khách hàng xác nhận đã nhận hàng</h6>
                                                  <p class="text-muted mb-0">
                                                       <small th:text="${#temporals.format(order.confirmedByUserAt, 'dd/MM/yyyy HH:mm')}"></small>
                                                  </p>
                                             </div>
                                        </div>
                                        
                                        <!-- Cancelled -->
                                        <div class="timeline-item" th:if="${order.status.name() == 'CANCELLED'}">
                                             <div class="timeline-marker bg-danger"></div>
                                             <div class="timeline-content">
                                                  <h6 class="mb-1"><i class="fas fa-times-circle me-2"></i>Đơn hàng đã hủy</h6>
                                                  <p class="text-muted mb-0">
                                                       <small th:if="${order.updatedAt != null}" th:text="${#temporals.format(order.updatedAt, 'dd/MM/yyyy HH:mm')}"></small>
                                                  </p>
                                             </div>
                                        </div>
                                   </div>
                              </div>
                         </div>

                         <!-- Order Items -->
                         <div class="card" th:if="${order != null}">
                              <div class="card-header">
                                   <h5><i class="fas fa-list"></i> Sản phẩm đặt hàng</h5>
                              </div>
                              <div class="card-body">
                                   <div
                                        th:if="${order.orderItems == null || #lists.isEmpty(order.orderItems)}"
                                        class="text-center text-muted py-3"
                                   >
                                        <p>Không có sản phẩm nào trong đơn hàng</p>
                                   </div>
                                   <div
                                        th:unless="${order.orderItems == null || #lists.isEmpty(order.orderItems)}"
                                        class="table-responsive"
                                   >
                                        <table class="table">
                                             <thead>
                                                  <tr>
                                                       <th>Mã sản phẩm</th>
                                                       <th>Thông tin sản phẩm</th>
                                                       <th class="text-center">Số lượng</th>
                                                       <th class="text-end">Đơn giá</th>
                                                       <th class="text-end">Thành tiền</th>
                                                  </tr>
                                             </thead>
                                             <tbody>
                                                  <tr th:each="item : ${order.orderItems}">
                                                      
                                                      <!-- Cột Mã sản phẩm -->
                                                      <td class="text-muted fw-semibold" style="white-space: nowrap;">
                                                            <span th:text="${item.productId}"></span>
                                                      </td>
                                                  
                                                      <!-- Cột Sản phẩm -->
                                                      <td>
                                                            <div class="d-flex align-items-center gap-2">
                                                            <!-- Ảnh -->
                                                                 <img th:src="${item.productImage != null ? item.productImage : '/images/no-image.png'}"
                                                                      alt="Ảnh sản phẩm"
                                                                      class="rounded"
                                                                      style="width:60px;height:60px;object-fit:cover;"/>
                                                                 <!-- Nội dung sản phẩm -->
                                                                 <div>
                                                                      <div class="fw-semibold" 
                                                                           th:text="${item.productName ?: 'N/A'}">
                                                                      </div>
                                                            
                                                                      <!-- Thuộc tính -->
                                                                      <div th:if="${item.styleValueNames != null && !#lists.isEmpty(item.styleValueNames)}"
                                                                           class="text-muted small">
                                                                           <span th:text="${#strings.listJoin(item.styleValueNames, ', ')}"></span>
                                                                      </div>
                                                                 </div>
                                                            </div>
                                                       </td>                                                   
                                                  
                                                      <!-- SL -->
                                                      <td class="text-center" th:text="${item.quantity ?: 0}"></td>
                                                  
                                                      <!-- Đơn giá -->
                                                      <td class="text-end">
                                                          <span th:text="${item.price != null ? #numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT') : '0'}"></span> VNĐ
                                                      </td>
                                                  
                                                      <!-- Thành tiền -->
                                                      <td class="text-end fw-bold">
                                                          <span th:text="${item.quantity != null && item.price != null ? #numbers.formatDecimal(item.quantity * item.price, 0, 'COMMA', 0, 'POINT') : '0'}"></span> VNĐ
                                                      </td>
                                                  </tr>
                                             </tbody>
                                             <tfoot>
                                                  <!-- Subtotal before discounts -->
                                                  <tr>
                                                       <td colspan="4" class="text-end">
                                                            <strong>Tạm tính:</strong>
                                                       </td>
                                                       <td class="text-end">
                                                            <span
                                                                 th:text="${order.totalAmount != null && order.promotionDiscount != null && order.voucherDiscount != null ? 
                                                #numbers.formatDecimal(order.totalAmount + order.promotionDiscount + order.voucherDiscount, 0, 'COMMA', 0, 'POINT') : 
                                                (order.totalAmount != null ? #numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT') : '0')}"
                                                                 >0</span
                                                            >
                                                            VNĐ
                                                       </td>
                                                  </tr>

                                                  <!-- Promotion Discount (Shop) -->
                                                  <tr
                                                       th:if="${order.promotionDiscount != null && order.promotionDiscount > 0}"
                                                  >
                                                       <td colspan="4" class="text-end">
                                                            <strong class="text-success">
                                                                 <i class="fas fa-gift me-1"></i
                                                                 >Khuyến mãi shop:
                                                            </strong>
                                                            <br />
                                                            <small
                                                                 class="text-muted"
                                                                 th:text="${order.promotionName}"
                                                                 >Promotion name</small
                                                            >
                                                       </td>
                                                       <td class="text-end text-success">
                                                            <strong
                                                                 >-<span
                                                                      th:text="${#numbers.formatDecimal(order.promotionDiscount, 0, 'COMMA', 0, 'POINT')}"
                                                                      >0</span
                                                                 >
                                                                 VNĐ</strong
                                                            >
                                                       </td>
                                                  </tr>

                                                  <!-- Voucher Discount (Platform) -->
                                                  <tr
                                                       th:if="${order.voucherDiscount != null && order.voucherDiscount > 0}"
                                                  >
                                                       <td colspan="4" class="text-end">
                                                            <strong class="text-danger">
                                                                 <i
                                                                      class="fas fa-ticket-alt me-1"
                                                                 ></i
                                                                 >Voucher toàn sàn:
                                                            </strong>
                                                            <br />
                                                            <small
                                                                 class="text-muted"
                                                                 th:text="'Mã: ' + ${order.voucherCode}"
                                                                 >Voucher code</small
                                                            >
                                                       </td>
                                                       <td class="text-end text-danger">
                                                            <strong
                                                                 >-<span
                                                                      th:text="${#numbers.formatDecimal(order.voucherDiscount, 0, 'COMMA', 0, 'POINT')}"
                                                                      >0</span
                                                                 >
                                                                 VNĐ</strong
                                                            >
                                                       </td>
                                                  </tr>

                                                  <tr>
                                                       <td colspan="4" class="text-end">
                                                            <strong>Phí vận chuyển:</strong>
                                                       </td>
                                                       <td class="text-end">
                                                            <span
                                                                 th:text="${order.shippingFee != null ? #numbers.formatDecimal(order.shippingFee, 0, 'COMMA', 0, 'POINT') : '0'}"
                                                                 >0</span
                                                            >
                                                            VNĐ
                                                       </td>
                                                  </tr>
                                                  <tr class="table-success">
                                                       <td colspan="4" class="text-end">
                                                            <strong>TỔNG CỘNG:</strong>
                                                       </td>
                                                       <td class="text-end">
                                                            <strong class="text-success fs-5">
                                                                 <span
                                                                      th:text="${order.totalAmount != null ? #numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT') : '0'}"
                                                                      >0</span
                                                                 >
                                                                 VNĐ
                                                            </strong>
                                                       </td>
                                                  </tr>
                                             </tfoot>
                                        </table>
                                   </div>
                              </div>
                         </div>
                    </div>
               </div>
          </div>

          <!-- Cancel Order Modal -->
          <div class="modal fade" id="cancelModal" tabindex="-1" th:if="${order != null}">
               <div class="modal-dialog">
                    <div class="modal-content">
                         <form
                              th:action="@{/vendor/orders/{id}/cancel(id=${order.orderId})}"
                              method="post"
                         >
                              <div class="modal-header">
                                   <h5 class="modal-title">Hủy đơn hàng</h5>
                                   <button
                                        type="button"
                                        class="btn-close"
                                        data-bs-dismiss="modal"
                                   ></button>
                              </div>
                              <div class="modal-body">
                                   <div class="mb-3">
                                        <label for="reason" class="form-label"
                                             >Lý do hủy đơn:</label
                                        >
                                        <textarea
                                             class="form-control"
                                             id="reason"
                                             name="reason"
                                             rows="3"
                                             required
                                        ></textarea>
                                   </div>
                                   <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle"></i> Nếu đơn đã xác
                                        nhận, hàng sẽ được hoàn lại kho và tiền sẽ được hoàn cho
                                        khách hàng.
                                   </div>
                              </div>
                              <div class="modal-footer">
                                   <button
                                        type="button"
                                        class="btn-secondary"
                                        data-bs-dismiss="modal"
                                   >
                                        Đóng
                                   </button>
                                   <button type="submit" class="btn btn-danger">
                                        Xác nhận hủy
                                   </button>
                              </div>
                         </form>
                    </div>
               </div>
          </div>

          <div th:replace="~{fragments/footer :: footer}"></div>
     </body>
</html>
