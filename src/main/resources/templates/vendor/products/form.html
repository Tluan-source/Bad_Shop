<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head th:replace="~{fragments/head :: head}">
    <title>Product Form - Badminton Marketplace</title>
</head>
<body>
    <div th:replace="~{fragments/header :: header}"></div>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Sidebar -->
            <div th:replace="~{vendor/fragments/sidebar :: sidebar('products')}"></div>

            <!-- Main content -->
            <div class="col-md-10">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>
                        <i th:class="${isEdit ? 'fas fa-edit' : 'fas fa-plus'}"></i> 
                        <span th:text="${isEdit ? 'Chỉnh sửa sản phẩm' : 'Thêm sản phẩm mới'}">Product Form</span>
                    </h2>
                    <a th:href="@{/vendor/products}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Quay lại
                    </a>
                </div>

                <!-- Product Form -->
                <div class="card">
                    <div class="card-body">
                        
                <form th:action="@{${isEdit ? '/vendor/products/' + product.id + '/update' : '/vendor/products/create'}}" 
                    method="post" th:object="${productDTO}" enctype="multipart/form-data">
                            
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label for="name" class="form-label">Tên sản phẩm <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="name" th:field="*{name}" 
                                               th:classappend="${#fields.hasErrors('name')} ? 'is-invalid' : ''" required>
                                        <div class="invalid-feedback" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="description" class="form-label">Mô tả sản phẩm <span class="text-danger">*</span></label>
                                        <textarea class="form-control" id="description" rows="4" th:field="*{description}" 
                                                  th:classappend="${#fields.hasErrors('description')} ? 'is-invalid' : ''" required></textarea>
                                        <div class="invalid-feedback" th:if="${#fields.hasErrors('description')}" th:errors="*{description}"></div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="categoryId" class="form-label">Danh mục <span class="text-danger">*</span></label>
                                                <select class="form-select" id="categoryId" th:field="*{categoryId}" 
                                                        th:classappend="${#fields.hasErrors('categoryId')} ? 'is-invalid' : ''" required>
                                                    <option value="">-- Chọn danh mục --</option>
                                                    <option th:each="category : ${categories}" 
                                                            th:value="${category.id}" 
                                                            th:text="${category.name}">Category</option>
                                                </select>
                                                <div class="invalid-feedback" th:if="${#fields.hasErrors('categoryId')}" th:errors="*{categoryId}"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Style Values Section (Màu sắc, Kích thước...) -->
                            <div class="mb-3" th:if="${styles != null and !styles.empty}">
                                <label class="form-label">Thuộc tính sản phẩm</label>
                                <div id="styleAttributesContainer">
                                    <div class="alert alert-warning" id="noStylesMessage" style="display: none;">
                                        <i class="fas fa-info-circle"></i> 
                                        Vui lòng chọn danh mục để hiển thị thuộc tính sản phẩm phù hợp
                                    </div>
                                    
                                    <div class="row">
                                        <div th:each="style : ${styles}" 
                                             class="col-md-6 mb-3 style-group" 
                                             th:data-category-ids="${style.categoryIds}"
                                             th:data-style-id="${style.id}"
                                             style="display: none;">
                                            <label th:text="${style.name}" class="form-label fw-bold">Style Name</label>
                                            <div class="d-flex flex-wrap gap-2">
                                                <div th:each="value : ${styleValues}" th:if="${value.style.id == style.id}">
                                                    <input type="checkbox" 
                                                           th:id="'styleValue_' + ${value.id}"
                                                           name="styleValueIds" 
                                                           th:value="${value.id}"
                                                           th:checked="${selectedStyleValueIds != null and selectedStyleValueIds.contains(value.id)}"
                                                           class="btn-check style-value-checkbox"
                                                           th:data-style-id="${style.id}">
                                                    <label th:for="'styleValue_' + ${value.id}" 
                                                           th:text="${value.name}"
                                                           class="btn btn-outline-primary btn-sm">Value</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <small class="text-muted">Các thuộc tính sẽ hiển thị dựa trên danh mục sản phẩm bạn chọn</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Hình ảnh sản phẩm</label>
                                <div class="mb-2">
                                    <div th:if="${isEdit}">
                                        <input id="newImagesInput" type="file" th:field="*{newImages}" multiple accept="image/*" class="form-control" />
                                    </div>
                                    <div th:unless="${isEdit}">
                                        <input id="imagesInput" type="file" th:field="*{images}" multiple accept="image/*" class="form-control" />
                                    </div>
                                </div>
                                <!-- Vendor uploads images via file input only (no manual URL input) -->
                                <small class="text-muted">Chọn ảnh từ máy của bạn. Ảnh sẽ được upload lên Cloudinary khi lưu sản phẩm.</small>
                                
                                <!-- Preview ảnh hiện tại khi edit (với nút xóa) -->
                                <div th:if="${isEdit && product != null && product.listImages != null && !product.listImages.equals('[]')}" class="mt-3">
                                    <label class="form-label">Ảnh hiện tại:</label>
                                    <!-- Hidden input bound to DTO.listImages (JSON string of remaining images) -->
                                    <input type="hidden" th:field="*{listImages}" id="listImagesInput" />
                                    <div class="d-flex flex-wrap gap-2" id="currentImagesPreview"></div>
                                    <script th:inline="javascript">
                                        /*<![CDATA[*/
                                        var existingListImages = /*[[${product.listImages}]]*/ '[]';
                                        try {
                                            var existingImages = JSON.parse(existingListImages);
                                        } catch (e) {
                                            var existingImages = [];
                                        }

                                        // Initialize hidden input with existing JSON
                                        var listInput = document.getElementById('listImagesInput');
                                        if (listInput) listInput.value = JSON.stringify(existingImages);

                                        var currentPreview = document.getElementById('currentImagesPreview');
                                        function renderCurrentImages() {
                                            currentPreview.innerHTML = '';
                                            existingImages.forEach(function(url, idx) {
                                                var wrapper = document.createElement('div');
                                                wrapper.className = 'position-relative';
                                                wrapper.style.width = '150px';
                                                wrapper.style.height = '150px';

                                                var img = document.createElement('img');
                                                img.src = url;
                                                img.className = 'img-thumbnail';
                                                img.style.width = '100%';
                                                img.style.height = '100%';
                                                img.style.objectFit = 'cover';
                                                wrapper.appendChild(img);

                                                var btn = document.createElement('button');
                                                btn.type = 'button';
                                                btn.className = 'btn btn-sm btn-danger position-absolute';
                                                btn.style.top = '4px';
                                                btn.style.right = '4px';
                                                btn.innerHTML = '<i class="fas fa-times"></i>';
                                                btn.onclick = function(e) {
                                                    e.preventDefault();
                                                    existingImages.splice(idx, 1);
                                                    if (listInput) listInput.value = JSON.stringify(existingImages);
                                                    renderCurrentImages();
                                                };
                                                wrapper.appendChild(btn);

                                                currentPreview.appendChild(wrapper);
                                            });
                                        }

                                        // Initial render
                                        renderCurrentImages();
                                        /*]]>*/
                                    </script>
                                </div>

                                <!-- Selected files preview (client-side before upload) -->
                                <div class="mt-3">
                                    <label class="form-label">Ảnh đã chọn (xem trước):</label>
                                    <div id="selectedImagesPreview" class="d-flex flex-wrap gap-2"></div>
                                </div>

                                <script th:inline="javascript">
                                    /*<![CDATA[*/
                                    // Helper: create thumbnail card
                                    function createThumb(url, index, onRemove) {
                                        const wrapper = document.createElement('div');
                                        wrapper.className = 'position-relative';
                                        wrapper.style.width = '100px';
                                        wrapper.style.height = '100px';

                                        const img = document.createElement('img');
                                        img.src = url;
                                        img.className = 'img-thumbnail';
                                        img.style.width = '100%';
                                        img.style.height = '100%';
                                        img.style.objectFit = 'cover';
                                        wrapper.appendChild(img);

                                        const btn = document.createElement('button');
                                        btn.type = 'button';
                                        btn.className = 'btn btn-sm btn-danger position-absolute';
                                        btn.style.top = '4px';
                                        btn.style.right = '4px';
                                        btn.innerHTML = '<i class="fas fa-times"></i>';
                                        btn.onclick = function(e) { e.preventDefault(); onRemove(index); };
                                        wrapper.appendChild(btn);

                                        return wrapper;
                                    }

                                    // Manage previews for a given input id
                                    function setupMultiFilePreview(inputId) {
                                        const input = document.getElementById(inputId);
                                        if (!input) return;
                                        const preview = document.getElementById('selectedImagesPreview');
                                        let filesArray = [];

                                        function refreshPreview() {
                                            preview.innerHTML = '';
                                            filesArray.forEach((file, idx) => {
                                                const url = URL.createObjectURL(file);
                                                const thumb = createThumb(url, idx, removeAtIndex);
                                                preview.appendChild(thumb);
                                            });
                                        }

                                        function removeAtIndex(i) {
                                            filesArray.splice(i, 1);
                                            // rebuild DataTransfer and assign back to input.files
                                            const dt = new DataTransfer();
                                            filesArray.forEach(f => dt.items.add(f));
                                            input.files = dt.files;
                                            refreshPreview();
                                        }

                                        input.addEventListener('change', function() {
                                            // When user selects files, convert FileList to array
                                            const newFiles = Array.from(input.files || []);
                                            // Append newly selected files to existing selection so user can add more files
                                            // Avoid exact same File object duplicates by name+size
                                            newFiles.forEach(nf => {
                                                const exists = filesArray.some(ef => ef.name === nf.name && ef.size === nf.size && ef.lastModified === nf.lastModified);
                                                if (!exists) filesArray.push(nf);
                                            });
                                            // Rebuild the input.files from filesArray so that form submission contains all files
                                            const dt = new DataTransfer();
                                            filesArray.forEach(f => dt.items.add(f));
                                            input.files = dt.files;
                                            refreshPreview();
                                        });
                                    }

                                    // Initialize for both possible inputs
                                    document.addEventListener('DOMContentLoaded', function() {
                                        setupMultiFilePreview('imagesInput');
                                        setupMultiFilePreview('newImagesInput');
                                    });
                                    /*]]>*/
                                </script>
                            </div>

            <hr>

                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="price" class="form-label">Giá bán <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="price" th:field="*{price}" 
                                                   th:classappend="${#fields.hasErrors('price')} ? 'is-invalid' : ''" 
                                                   step="1000" min="0" required>
                                            <span class="input-group-text">VNĐ</span>
                                            <div class="invalid-feedback" th:if="${#fields.hasErrors('price')}" th:errors="*{price}"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="promotionalPrice" class="form-label">Giá khuyến mãi</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="promotionalPrice" th:field="*{promotionalPrice}" 
                                                   th:classappend="${#fields.hasErrors('promotionalPrice')} ? 'is-invalid' : ''" 
                                                   step="1000" min="0">
                                            <span class="input-group-text">VNĐ</span>
                                            <div class="invalid-feedback" th:if="${#fields.hasErrors('promotionalPrice')}" th:errors="*{promotionalPrice}"></div>
                                        </div>
                                        <small class="text-muted">Để trống nếu không có khuyến mãi</small>
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="quantity" class="form-label">Số lượng <span class="text-danger">*</span></label>
                                        <input type="number" class="form-control" id="quantity" th:field="*{quantity}" 
                                               th:classappend="${#fields.hasErrors('quantity')} ? 'is-invalid' : ''" 
                                               min="0" required>
                                        <div class="invalid-feedback" th:if="${#fields.hasErrors('quantity')}" th:errors="*{quantity}"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <a th:href="@{/vendor/products}" class="btn btn-secondary">
                                    <i class="fas fa-times"></i> Hủy
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> <span th:text="${isEdit ? 'Cập nhật' : 'Thêm sản phẩm'}">Save</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="~{fragments/footer :: footer}"></div>
    
    <!-- JavaScript for dynamic style filtering -->
    <script th:inline="javascript">
        let isInitialLoad = true; // Track if this is the first load
        
        // Function to filter styles based on selected category
        function filterStylesByCategory(shouldUncheck = true) {
            const categorySelect = document.getElementById('categoryId');
            const selectedCategoryId = categorySelect.value;
            const styleGroups = document.querySelectorAll('.style-group');
            const noStylesMessage = document.getElementById('noStylesMessage');
            
            // If no category selected, hide all styles and show message
            if (!selectedCategoryId || selectedCategoryId === '') {
                styleGroups.forEach(group => {
                    group.style.display = 'none';
                    // Only uncheck if user is changing category (not on initial load)
                    if (shouldUncheck) {
                        uncheckStyleGroup(group);
                    }
                });
                noStylesMessage.style.display = 'block';
                return;
            }
            
            // Hide the "please select category" message
            noStylesMessage.style.display = 'none';
            
            let hasVisibleStyles = false;
            
            // Filter and show/hide style groups
            styleGroups.forEach(group => {
                const categoryIdsJson = group.getAttribute('data-category-ids');
                
                try {
                    // Parse the JSON array of category IDs
                    const categoryIds = JSON.parse(categoryIdsJson || '[]');
                    
                    // Check if selected category is in the style's category list
                    if (categoryIds.includes(selectedCategoryId)) {
                        group.style.display = 'block';
                        hasVisibleStyles = true;
                    } else {
                        group.style.display = 'none';
                        // Only uncheck if user is changing category (not on initial load when editing)
                        if (shouldUncheck) {
                            uncheckStyleGroup(group);
                        }
                    }
                } catch (e) {
                    console.error('Error parsing category IDs:', e);
                    group.style.display = 'none';
                }
            });
            
            // If no styles match the category, show a message
            if (!hasVisibleStyles) {
                noStylesMessage.innerHTML = '<i class="fas fa-info-circle"></i> Danh mục này chưa có thuộc tính sản phẩm nào.';
                noStylesMessage.style.display = 'block';
            }
        }
        
        // Helper function to uncheck all checkboxes in a style group
        function uncheckStyleGroup(group) {
            const checkboxes = group.querySelectorAll('.style-value-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            const categorySelect = document.getElementById('categoryId');
            
            if (!categorySelect.value || categorySelect.value === '') {
                // New product: no category selected
                document.getElementById('noStylesMessage').style.display = 'block';
            } else {
                // Edit mode: category pre-selected, show styles but DON'T uncheck
                filterStylesByCategory(false); // false = don't uncheck pre-selected values
            }
            
            // After initial load, mark as no longer initial
            isInitialLoad = false;
            
            // Add event listener for category change (will uncheck when user changes)
            categorySelect.addEventListener('change', function() {
                filterStylesByCategory(true); // true = uncheck when user changes category
            });
        });
    </script>
</body>
</html>
