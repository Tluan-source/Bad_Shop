<!DOCTYPE html>
<html
     xmlns:th="http://www.thymeleaf.org"
     xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
     lang="vi"
>
     <head>
          <th:block th:replace="~{fragments/head :: head}"></th:block>
          <title>Đơn hàng của tôi - Badminton Store</title>
          <style>
               .btn-review-yellow {
                    background-color: #ffbc1c !important;
                    border: none !important;
                    color: #fff !important;
                    font-weight: 600;
                    padding: 6px 14px;
                    border-radius: 6px;
                    transition: 0.15s;
               }

               .btn-review-yellow:hover {
                    background-color: #ffa800 !important; /* vàng đậm hơn */
                    color: #fff !important;
                    box-shadow: 0 2px 6px rgba(255, 168, 0, 0.45);
                    transform: translateY(-2px);
               }

               .btn-review-yellow:active {
                    transform: scale(0.97);
               }

               .order-card {
                    border: 1px solid #dee2e6;
                    border-radius: 8px;
                    margin-bottom: 20px;
                    transition: box-shadow 0.15s ease;
                    position: relative;
                    will-change: box-shadow;
                    contain: layout paint;
               }
               .order-card:hover {
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
               }
               .order-header {
                    background-color: #f8f9fa;
                    padding: 15px 20px;
                    border-bottom: 1px solid #dee2e6;
                    border-radius: 8px 8px 0 0;
               }
               .order-body {
                    padding: 20px;
               }
               .order-status {
                    padding: 5px 15px;
                    border-radius: 20px;
                    font-size: 0.875rem;
                    font-weight: 500;
               }
               .status-pending {
                    background-color: #fff3cd;
                    color: #856404;
               }
               .status-confirmed {
                    background-color: #cce5ff;
                    color: #004085;
               }
               .status-shipping,
               .status-shipped {
                    background-color: #d1ecf1;
                    color: #0c5460;
               }
               .status-awaiting_confirmation {
                    background-color: #fff3cd;
                    color: #856404;
               }
               .status-delivered {
                    background-color: #d4edda;
                    color: #155724;
               }
               .status-cancelled {
                    background-color: #f8d7da;
                    color: #721c24;
               }
               .status-refunded {
                    background-color: #e2e3e5;
                    color: #383d41;
               }
               .product-item {
                    display: flex;
                    gap: 15px;
                    padding: 10px 0;
                    border-bottom: 1px solid #f0f0f0;
               }
               .product-item:last-child {
                    border-bottom: none;
               }
               .product-image {
                    width: 80px;
                    height: 80px;
                    object-fit: cover;
                    border-radius: 4px;
               }
               .product-info {
                    flex: 1;
               }
               .truncate {
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
               }
               .empty-state {
                    text-align: center;
                    padding: 60px 20px;
               }
               .empty-state i {
                    font-size: 4rem;
                    color: #dee2e6;
                    margin-bottom: 20px;
               }
          </style>
     </head>
     <body>
          <!-- Header -->
          <th:block th:replace="~{fragments/header :: header}"></th:block>

          <div class="container my-5">
               <div class="row">
                    <div class="col-12">
                         <div
                              class="d-flex flex-wrap justify-content-between align-items-center mb-4"
                         >
                              <h2 class="mb-3 mb-md-0">
                                   <i class="fas fa-shopping-bag me-2"></i>Đơn hàng của tôi
                              </h2>
                              <div class="d-flex align-items-center gap-2 flex-wrap">
                                   <label for="dateFilter" class="me-2 text-muted"
                                        >Lọc theo ngày:</label
                                   >
                                   <select
                                        id="dateFilter"
                                        class="form-select form-select-sm"
                                        style="width: auto"
                                        onchange="handleDateFilterChange(this.value);"
                                   >
                                        <option value="" th:selected="${param.date == null}">
                                             Tất cả
                                        </option>
                                        <option value="7" th:selected="${param.date == '7'}">
                                             7 ngày
                                        </option>
                                        <option value="30" th:selected="${param.date == '30'}">
                                             30 ngày
                                        </option>
                                        <option
                                             value="custom"
                                             th:selected="${param.date != null && param.date != '7' && param.date != '30'}"
                                        >
                                             Chọn ngày cụ thể
                                        </option>
                                   </select>
                                   <input
                                        type="date"
                                        id="customDate"
                                        class="form-control form-control-sm"
                                        style="width: auto; display: none"
                                        th:value="${param.date != null && param.date != '7' && param.date != '30' ? param.date : ''}"
                                        onchange="if(this.value) { const url = baseUrl + '?date=' + this.value; window.location.href = url; }"
                                   />
                              </div>
                              <script th:inline="javascript">
                                   /*<![CDATA[*/
                                   const baseUrl = /*[[@{/orders}]]*/ "/orders";
                                   function handleDateFilterChange(value) {
                                        const customDateInput =
                                             document.getElementById("customDate");
                                        if (value === "custom") {
                                             customDateInput.style.display = "inline-block";
                                             customDateInput.focus();
                                        } else if (
                                             value === "" ||
                                             value === "7" ||
                                             value === "30"
                                        ) {
                                             customDateInput.style.display = "none";
                                             if (value) {
                                                  window.location.href = baseUrl + "?date=" + value;
                                             } else {
                                                  window.location.href = baseUrl;
                                             }
                                        }
                                   }
                                   // Show custom date input if current filter is a date
                                   (function () {
                                        const dateFilter = document.getElementById("dateFilter");
                                        const customDateInput =
                                             document.getElementById("customDate");
                                        if (
                                             dateFilter &&
                                             customDateInput &&
                                             customDateInput.value
                                        ) {
                                             dateFilter.value = "custom";
                                             customDateInput.style.display = "inline-block";
                                        }
                                   })();
                                   /*]]>*/
                              </script>
                         </div>

                         <!-- Empty state -->
                         <div class="empty-state" th:if="${orders == null || orders.isEmpty()}">
                              <i class="fas fa-receipt"></i>
                              <h4>Chưa có đơn hàng nào</h4>
                              <p class="text-muted">Bạn chưa có đơn hàng nào. Hãy mua sắm ngay!</p>
                              <a th:href="@{/products}" class="btn btn-primary">
                                   <i class="fas fa-shopping-cart me-2"></i>Tiếp tục mua sắm
                              </a>
                         </div>

                         <!-- Orders list -->
                         <div th:if="${orders != null && !orders.isEmpty()}">
                              <div class="order-card" th:each="order : ${orders}">
                                   <!-- Order header -->
                                   <div class="order-header">
                                        <div class="row align-items-center">
                                             <div class="col-md-6">
                                                  <div>
                                                       <span class="text-muted">Mã đơn hàng:</span>
                                                       <strong th:text="${order.id}"></strong>
                                                  </div>
                                                  <div class="mt-1">
                                                       <small class="text-muted">
                                                            <i class="far fa-clock me-1"></i>
                                                            <span
                                                                 th:text="${order.createdAt != null ? #temporals.format(order.createdAt, 'dd/MM/yyyy HH:mm') : (order.updatedAt != null ? #temporals.format(order.updatedAt, 'dd/MM/yyyy HH:mm') : 'Chưa có thời gian')}"
                                                            ></span>
                                                       </small>
                                                  </div>
                                             </div>
                                             <div class="col-md-6 text-md-end mt-2 mt-md-0">
                                                  <span
                                                       class="order-status"
                                                       th:classappend="${'status-' + #strings.toLowerCase(order.status)}"
                                                       th:text=" ${
                                                             order.status == 'NOT_PROCESSED' ? 'Chờ xác nhận' : 
                                                             order.status == 'PROCESSING' ? 'Đã xác nhận' :
                                                             order.status == 'DELIVERING' ? 'Đang giao' :
                                                             order.status == 'AWAITING_CONFIRMATION' ? 'Đã giao - Chờ xác nhận' :
                                                             order.status == 'DELIVERED' ? 'Đã giao' :
                                                             order.status == 'CANCELLED' ? 'Đã hủy' :
                                                             order.status == 'RETURNED' ? 'Trả hàng' : order.status
                                                        } "
                                                  >
                                                  </span>
                                             </div>
                                        </div>
                                   </div>

                                   <!-- Order body -->
                                   <div class="order-body">
                                        <!-- Store and delivery info -->
                                        <div class="row mb-3 g-2">
                                             <div class="col-md-6">
                                                  <div class="mb-2">
                                                       <i
                                                            class="fas fa-store me-2 text-primary"
                                                       ></i>
                                                       <a
                                                            th:href="@{/stores/{id}(id=${order.store.id})}"
                                                            class="text-decoration-none fw-bold truncate d-inline-block"
                                                            style="max-width: 100%"
                                                            th:text="${order.store.name}"
                                                       ></a>
                                                  </div>
                                                  <div>
                                                       <i
                                                            class="fas fa-map-marker-alt me-2 text-success"
                                                       ></i>
                                                       <small class="text-muted">
                                                            Giao đến:
                                                            <span
                                                                 th:title="${order.address}"
                                                                 th:text="${#strings.length(order.address) > 50 ? #strings.substring(order.address, 0, 50) + '...' : order.address}"
                                                            ></span>
                                                       </small>
                                                  </div>
                                             </div>
                                             <div class="col-md-6 text-md-end mt-2 mt-md-0">
                                                  <div>
                                                       <i class="fas fa-user me-2 text-info"></i>
                                                       <small
                                                            class="truncate d-inline-block"
                                                            style="max-width: 100%"
                                                            th:text="${order.user.fullName}"
                                                       ></small>
                                                  </div>
                                                  <div>
                                                       <i
                                                            class="fas fa-phone me-2 text-warning"
                                                       ></i>
                                                       <small th:text="${order.phone}"></small>
                                                  </div>
                                             </div>
                                        </div>

                                        <hr class="my-3" />

                                        <!-- Products summary -->
                                        <div class="mb-3 d-flex align-items-center">
                                             <strong class="me-2">
                                                  <i class="fas fa-box me-2"></i>
                                                  Sản phẩm
                                             </strong>
                                             <span
                                                  class="badge bg-secondary"
                                                  th:text="${#lists.size(order.orderItems)}"
                                             ></span>
                                        </div>

                                        <!-- Products - Show max 2 items -->
                                        <div
                                             th:each="item, iterStat : ${order.orderItems}"
                                             th:if="${iterStat.index < 2}"
                                        >
                                             <div class="product-item">
                                                  <img
                                                       th:src="${item.product.firstImage}"
                                                       th:alt="${item.product.name}"
                                                       class="product-image"
                                                       loading="lazy"
                                                  />
                                                  <div class="product-info">
                                                       <h6
                                                            class="mb-1 truncate"
                                                            th:title="${item.product.name}"
                                                            th:text="${item.product.name}"
                                                       ></h6>
                                                       <!-- Store name with link -->
                                                       <p class="mb-1">
                                                            <small class="text-muted">
                                                                 <i class="fas fa-store me-1"></i>
                                                                 Cửa hàng:
                                                                 <a
                                                                      th:href="@{/stores/{id}(id=${item.product.store.id})}"
                                                                      class="text-decoration-none fw-semibold truncate d-inline-block"
                                                                      style="max-width: 100%"
                                                                      th:text="${item.product.store.name}"
                                                                 ></a>
                                                            </small>
                                                       </p>
                                                       <!-- Product attributes -->
                                                       <p
                                                            class="text-muted mb-1"
                                                            th:if="${item.styleValueNames != null and !item.styleValueNames.isEmpty()}"
                                                       >
                                                            <small>
                                                                 <i class="fas fa-tags me-1"></i>
                                                                 Thuộc tính:
                                                                 <span
                                                                      th:text="${#strings.listJoin(item.styleValueNames, ', ')}"
                                                                 ></span>
                                                            </small>
                                                       </p>
                                                       <p class="text-muted mb-1">
                                                            Số lượng:
                                                            <span th:text="${item.quantity}"></span>
                                                            x
                                                            <span
                                                                 th:text="|${item.price != null ? #numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT') : '0'} đ|"
                                                            ></span>
                                                       </p>
                                                       <p class="mb-0">
                                                            <strong
                                                                 class="text-danger"
                                                                 th:text="|${item.total != null ? #numbers.formatDecimal(item.total, 0, 'COMMA', 0, 'POINT') : '0'} đ|"
                                                            ></strong>
                                                       </p>
                                                  </div>
                                             </div>
                                        </div>

                                        <!-- Show more products indicator -->
                                        <div
                                             th:if="${#lists.size(order.orderItems) > 2}"
                                             class="text-center py-2"
                                        >
                                             <a
                                                  th:href="@{/orders/{id}(id=${order.id})}"
                                                  class="text-muted text-decoration-none"
                                             >
                                                  <small>
                                                       <i class="fas fa-ellipsis-h me-1"></i>
                                                       Còn
                                                       <span
                                                            th:text="${#lists.size(order.orderItems) - 2}"
                                                       ></span>
                                                       sản phẩm khác
                                                  </small>
                                             </a>
                                        </div>

                                        <!-- Order footer -->
                                        <div
                                             class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top"
                                        >
                                             <div>
                                                  <div class="mb-1">
                                                       <i
                                                            class="fas fa-money-bill-wave me-2 text-success"
                                                       ></i>
                                                       <small class="text-muted"
                                                            >Thanh toán khi nhận hàng</small
                                                       >
                                                  </div>
                                                  <div>
                                                       <span class="text-muted">Tổng tiền:</span>
                                                       <strong
                                                            class="text-danger fs-5 ms-2"
                                                            th:text="|${#numbers.formatDecimal(
                                                              ((order.amountFromUser != null ? order.amountFromUser : 0) +
                                                              (order.shippingProvider != null && order.shippingProvider.shippingFee != null ? order.shippingProvider.shippingFee : (order.shippingFee != null ? order.shippingFee : 0))),
                                                              0, 'COMMA', 0, 'POINT'
                                                            )} đ|"
                                                       ></strong>
                                                  </div>
                                             </div>
                                             <div class="d-flex gap-2">
                                                  <a
                                                       th:href="@{/user/chat(storeId=${order.store.id},orderId=${order.id})}"
                                                       class="btn btn-outline-success btn-sm"
                                                       title="Nhắn tin với shop về đơn hàng này"
                                                  >
                                                       <i class="fas fa-comment-dots me-1"></i>Nhắn
                                                       tin
                                                  </a>
                                                  <a
                                                       th:href="@{/orders/{id}(id=${order.id})}"
                                                       class="btn btn-outline-primary btn-sm"
                                                  >
                                                       <i class="fas fa-eye me-1"></i>Chi tiết
                                                  </a>
                                                  <!-- Button: Confirm Received (Only when waiting confirmation) -->
                                                  <form
                                                       th:if="${order.status?.name() == 'AWAITING_CONFIRMATION'}"
                                                       th:action="@{/orders/{orderId}/confirm-receipt(orderId=${order.id})}"
                                                       method="post"
                                                       onsubmit="return confirm('Bạn xác nhận đã nhận được hàng?');"
                                                  >
                                                       <button
                                                            type="submit"
                                                            class="btn btn-success btn-sm"
                                                       >
                                                            <i class="fas fa-check-circle me-1"></i
                                                            >Đã nhận hàng
                                                       </button>
                                                  </form>
                                             </div>
                                        </div>
                                        <!-- Add review button for delivered orders -->
                                        <div
                                             th:if="${order.status?.name() == 'DELIVERED'}"
                                             class="text-end mt-3"
                                        >
                                             <a
                                                  th:href="@{/reviews/submit-review(orderId=${order.id})}"
                                                  class="btn btn-review-yellow btn-sm"
                                             >
                                                  <i class="fas fa-star me-2"></i>Đánh giá sản phẩm
                                             </a>
                                        </div>
                                   </div>
                              </div>
                         </div>
                    </div>
               </div>
          </div>

          <!-- Footer -->
          <th:block th:replace="~{fragments/footer :: footer}"></th:block>
     </body>
</html>
