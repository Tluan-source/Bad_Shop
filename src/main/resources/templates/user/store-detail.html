<!DOCTYPE html>
<html
     xmlns:th="http://www.thymeleaf.org"
     xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
     <head th:replace="~{fragments/head :: head}">
          <title>Chi tiết cửa hàng - Badminton Marketplace</title>
     </head>
     <body>
          <th:block th:replace="~{fragments/header :: header}"></th:block>

          <section class="py-5 bg-light">
               <div class="container">
                    <div class="card mb-4">
                         <div class="card-body">
                              <div class="row">
                                   <div class="col-md-8">
                                        <h2 class="mb-3">
                                             <i class="fas fa-store text-primary me-2"></i>
                                             <span th:text="${store.name}"></span>
                                        </h2>
                                        <p class="text-muted" th:text="${store.bio}"></p>
                                   </div>
                                   <div class="col-md-4 text-end">
                                        <div class="mb-2">
                                             <span class="badge bg-warning text-dark fs-5">
                                                  <i class="fas fa-star"></i>
                                                  <span th:text="${store.rating}"></span>
                                             </span>
                                        </div>
                                        <div class="text-muted mb-3">
                                             <i class="fas fa-box me-1"></i>
                                             <span
                                                  th:text="${products != null ? products.size() : 0}"
                                             ></span>
                                             sản phẩm
                                        </div>
                                        
                                        <!-- Chat button for authenticated users -->
                                        <div sec:authorize="isAuthenticated()">
                                             <button class="btn btn-primary btn-lg" onclick="startChat()" th:data-store-id="${store.id}">
                                                  <i class="fas fa-comment-dots me-2"></i>Nhắn tin với Shop
                                             </button>
                                        </div>
                                        
                                        <!-- Show login prompt for guests -->
                                        <div sec:authorize="!isAuthenticated()">
                                             <a th:href="@{/login}" class="btn btn-outline-primary btn-lg">
                                                  <i class="fas fa-sign-in-alt me-2"></i>Đăng nhập để nhắn tin
                                             </a>
                                        </div>
                                   </div>
                              </div>
                         </div>
                    </div>
               </div>
          </section>

          <section class="py-5">
               <div class="container">
                    <h3 class="mb-4">Sản phẩm của cửa hàng</h3>
                    <div class="row">
                         <div th:if="${#lists.isEmpty(products)}" class="col-12">
                              <div class="alert alert-info">
                                   <i class="fas fa-info-circle me-2"></i>Cửa hàng chưa có sản phẩm
                                   nào.
                              </div>
                         </div>

                         <div th:each="product : ${products}" class="col-md-3 mb-4">
                              <div class="card h-100">
                                   <img
                                        th:src="${product.listImages}"
                                        class="card-img-top"
                                        alt="Product Image"
                                        style="height: 200px; object-fit: cover"
                                   />
                                   <div class="card-body">
                                        <h5 class="card-title" th:text="${product.name}"></h5>
                                        <p class="card-text">
                                             <span
                                                  class="text-danger fw-bold"
                                                  th:text="${#numbers.formatCurrency(product.promotionalPrice ?: product.price)}"
                                             ></span>
                                             <span
                                                  th:if="${product.promotionalPrice}"
                                                  class="text-muted text-decoration-line-through ms-2"
                                                  th:text="${#numbers.formatCurrency(product.price)}"
                                             ></span>
                                        </p>
                                        <a
                                             th:href="@{/products/{id}(id=${product.id})}"
                                             class="btn btn-outline-primary w-100"
                                             >Xem chi tiết</a
                                        >
                                   </div>
                              </div>
                         </div>
                    </div>
               </div>
          </section>

          <th:block th:replace="~{fragments/footer-user :: footer-user}"></th:block>
          
          <script th:inline="javascript">
               function startChat() {
                    const storeId = /*[[${store.id}]]*/ '';
                    
                    // Get CSRF token
                    const csrfToken = document.querySelector('meta[name="_csrf"]');
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]');
                    
                    const headers = {
                         'Content-Type': 'application/x-www-form-urlencoded',
                    };
                    
                    // Add CSRF token if exists
                    if (csrfToken && csrfHeader) {
                         headers[csrfHeader.content] = csrfToken.content;
                    }
                    
                    console.log('Creating conversation with storeId:', storeId);
                    
                    // Create or get conversation
                    fetch('/api/chat/conversation?storeId=' + storeId, {
                         method: 'POST',
                         headers: headers,
                         credentials: 'same-origin'
                    })
                    .then(response => {
                         console.log('Response status:', response.status);
                         if (!response.ok) {
                              return response.json().then(errorData => {
                                   throw new Error(errorData.message || `HTTP ${response.status}: Có lỗi xảy ra`);
                              }).catch(() => {
                                   throw new Error(`HTTP ${response.status}: Có lỗi xảy ra`);
                              });
                         }
                         return response.json();
                    })
                    .then(conversation => {
                         console.log('Conversation created:', conversation);
                         // Redirect to chat page with conversationId
                         window.location.href = '/user/chat?conversationId=' + conversation.id;
                    })
                    .catch(error => {
                         console.error('Error details:', error);
                         alert(error.message || 'Có lỗi xảy ra khi tạo cuộc trò chuyện');
                    });
               }
          </script>
     </body>
</html>