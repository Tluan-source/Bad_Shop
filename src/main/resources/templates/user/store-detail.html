<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:replace="~{fragments/head :: head}">
    <title>Chi ti·∫øt c·ª≠a h√†ng - Badminton Marketplace</title>
</head>

<body>
<th:block th:replace="~{fragments/header :: header}"></th:block>

<section class="py-5 bg-light">
    <div class="container">
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <!-- Left: Store Info -->
                    <div class="col-md-8">
                        <h2 class="mb-3">
                            <i class="fas fa-store text-primary me-2"></i>
                            <span th:text="${store.name}"></span>
                        </h2>
                        <p class="text-muted" th:text="${store.bio}"></p>
                    </div>

                    <!-- Right: Rating / Chat -->
                    <div class="col-md-4 text-end">

                        <!-- N·∫øu c√≥ ƒë√°nh gi√° -->
                        <div class="mb-2" th:if="${store.rating != null and store.rating > 0}">
                            <span class="badge bg-warning text-dark fs-5">
                                <i class="fas fa-star"></i>
                                <span th:text="${store.rating}"></span>
                            </span>
                        </div>

                        <!-- N·∫øu ch∆∞a c√≥ ƒë√°nh gi√° -->
                        <div class="mb-2" th:if="${store.rating == null or store.rating == 0}">
                            <span class="text-muted small">Ch∆∞a c√≥ ƒë√°nh gi√°</span>
                        </div>

                        <!-- Product Count -->
                        <div class="text-muted mb-3">
                            <i class="fas fa-box me-1"></i>
                            <span th:text="${products != null ? products.size() : 0}"></span> s·∫£n ph·∫©m
                        </div>

                        <!-- Chat Button -->
                        <div sec:authorize="isAuthenticated()">
                            <button class="btn btn-primary btn-lg"
                                    onclick="startChat()"
                                    th:data-store-id="${store.id}">
                                <i class="fas fa-comment-dots me-2"></i>Nh·∫Øn tin v·ªõi Shop
                            </button>
                        </div>

                        <!-- Login prompt -->
                        <div sec:authorize="!isAuthenticated()">
                            <a th:href="@{/login}" class="btn btn-outline-primary btn-lg">
                                <i class="fas fa-sign-in-alt me-2"></i>ƒêƒÉng nh·∫≠p ƒë·ªÉ nh·∫Øn tin
                            </a>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</section>

<section class="py-5">
    <div class="container">
        <h3 class="mb-4">S·∫£n ph·∫©m c·ªßa c·ª≠a h√†ng</h3>

        <div th:if="${#lists.isEmpty(products)}" class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>C·ª≠a h√†ng ch∆∞a c√≥ s·∫£n ph·∫©m n√†o.
            </div>
        </div>

        <div class="row">
            <div th:each="product : ${products}" class="col-md-3 mb-4">
                <div class="card h-100">
                    <img th:src="${product.firstImage}" class="card-img-top"
                         style="height: 200px; object-fit: cover"/>

                    <div class="card-body">
                        <h5 class="card-title" th:text="${product.name}"></h5>

                        <!-- ‚≠ê Rating -->
                        <div class="product-rating mb-2">
                            <span th:each="i : ${#numbers.sequence(1,5)}">
                                <i th:classappend="
                                    ${i <= product.rating} ? 'fas fa-star text-warning' :
                                    (${i - product.rating <= 0.5} ? 'fas fa-star-half-alt text-warning' : 'far fa-star text-warning')
                                "></i>
                            </span>
                            <span class="text-muted ms-2">(<span th:text="${product.rating}"></span>)</span>
                        </div>

                        <!-- üí∞ Price -->
                        <p class="card-text">
                            <span class="text-danger fw-bold"
                                  th:text="${#numbers.formatDecimal(product.promotionalPrice ?: product.price, 0, 'POINT', 0, 'COMMA')} + ' ƒë'">
                            </span>

                            <span th:if="${product.promotionalPrice}"
                                  class="text-muted text-decoration-line-through ms-2"
                                  th:text="${#numbers.formatDecimal(product.price, 0, 'POINT', 0, 'COMMA')} + ' ƒë'">
                            </span>
                        </p>

                        <a th:href="@{/products/{id}(id=${product.id})}"
                           class="btn btn-outline-primary w-100">Xem chi ti·∫øt</a>
                    </div>

                </div>
            </div>
        </div>

    </div>
</section>

<th:block th:replace="~{fragments/footer-user :: footer-user}"></th:block>

<!-- Chat Script -->
<script th:inline="javascript">
function startChat() {
    const storeId = /*[[${store.id}]]*/ '';
    const csrfToken = document.querySelector('meta[name="_csrf"]');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]');

    const headers = {'Content-Type': 'application/x-www-form-urlencoded'};
    if (csrfToken && csrfHeader) {
        headers[csrfHeader.content] = csrfToken.content;
    }

    fetch('/api/chat/conversation?storeId=' + storeId, {
        method: 'POST', headers: headers, credentials: 'same-origin'
    })
    .then(r => r.json())
    .then(c => window.location.href = '/user/chat?conversationId=' + c.id)
    .catch(() => alert('C√≥ l·ªói x·∫£y ra khi t·∫°o cu·ªôc tr√≤ chuy·ªán'));
}
</script>

</body>
</html>
