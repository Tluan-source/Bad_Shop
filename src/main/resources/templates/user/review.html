<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
     <head>
          <meta charset="UTF-8" />
          <title>Đánh giá sản phẩm - Badminton Store</title>
          <link
               href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
               rel="stylesheet"
          />
          <link
               href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
               rel="stylesheet"
          />
          <style>
               body {
                    background-color: #f8f9fa;
               }

               .rating-star {
                    font-size: 1.8rem;
                    color: #ccc;
                    cursor: pointer;
                    transition: color 0.2s;
               }

               .rating-star i {
                    transition: color 0.2s;
               }

               /* Hover: làm sáng tất cả sao bên trái */
               .rating-star:hover i,
               .rating-star:hover ~ .rating-star i {
                    color: #ffc107;
               }

               /* Khi đã chọn thì cố định màu vàng */
               .rating-star.selected i {
                    color: #ffc107;
               }

               .preview-img {
                    width: 80px;
                    height: 80px;
                    object-fit: cover;
                    margin-right: 5px;
                    border-radius: 6px;
                    border: 1px solid #ddd;
               }
          </style>
     </head>
     <body>
          <div th:replace="~{fragments/header :: header}"></div>

          <div class="container my-5">
               <h3 class="mb-4 text-center">
                    <i class="fas fa-star me-2 text-warning"></i>Đánh giá sản phẩm
               </h3>

               <div th:each="item : ${items}" class="card mb-4 shadow-sm">
                    <div class="card-body">
                         <div class="d-flex align-items-center mb-3">
                              <img
                                   th:src="${item.product.listImages != null ? item.product.listImages : '/images/no-image.png'}"
                                   alt="Ảnh sản phẩm"
                                   class="me-3 rounded"
                                   style="width: 80px; height: 80px; object-fit: cover"
                              />

                              <div>
                                   <h5 class="mb-1" th:text="${item.product.name}">Tên sản phẩm</h5>
                                   <p class="text-muted mb-0">
                                        Mã sản phẩm: <span th:text="${item.product.id}"></span>
                                   </p>
                              </div>
                         </div>

                         <!-- ✅ Nếu đã đánh giá -->
                         <div th:if="${item.reviewed}" class="alert alert-info mb-0">
                              <i class="fas fa-check-circle text-success me-2"></i>
                              Bạn đã đánh giá sản phẩm này.
                         </div>

                         <!-- ✅ Nếu CHƯA đánh giá -->
                         <form
                              th:unless="${item.reviewed}"
                              th:action="@{/reviews}"
                              method="post"
                              enctype="multipart/form-data"
                              class="mt-3"
                         >
                              <input type="hidden" name="orderItemId" th:value="${item.id}" />
                              <input type="hidden" name="productId" th:value="${item.product.id}" />

                              <!-- Rating -->
                              <div class="mb-3">
                                   <label class="form-label fw-semibold">Đánh giá của bạn:</label
                                   ><br />
                                   <span class="rating-star" data-value="1"
                                        ><i class="fa fa-star"></i
                                   ></span>
                                   <span class="rating-star" data-value="2"
                                        ><i class="fa fa-star"></i
                                   ></span>
                                   <span class="rating-star" data-value="3"
                                        ><i class="fa fa-star"></i
                                   ></span>
                                   <span class="rating-star" data-value="4"
                                        ><i class="fa fa-star"></i
                                   ></span>
                                   <span class="rating-star" data-value="5"
                                        ><i class="fa fa-star"></i
                                   ></span>
                                   <input type="hidden" name="rating" required />
                              </div>

                              <!-- Comment -->
                              <div class="mb-3">
                                   <label class="form-label fw-semibold"
                                        >Nhận xét (tối đa 1000 ký tự):</label
                                   >
                                   <textarea
                                        name="comment"
                                        rows="3"
                                        maxlength="1000"
                                        class="form-control"
                                        placeholder="Viết cảm nhận của bạn về sản phẩm..."
                                   ></textarea>
                              </div>

                              <!-- Upload images -->
                              <div class="mb-3">
                                   <label class="form-label fw-semibold"
                                        >Ảnh minh họa (tối đa 5 ảnh):</label
                                   >
                                   <input
                                        type="file"
                                        name="images"
                                        class="form-control"
                                        multiple
                                        accept="image/*"
                                        onchange="previewImages(this)"
                                   />
                                   <div class="d-flex flex-wrap mt-2" id="preview-container"></div>
                              </div>

                              <button type="submit" class="btn btn-success">
                                   <i class="fas fa-paper-plane me-2"></i>Gửi đánh giá
                              </button>
                         </form>
                    </div>
               </div>
          </div>

          <script>
               document.addEventListener("DOMContentLoaded", function () {
                    // ⭐ Chọn sao
                    document.querySelectorAll(".rating-star").forEach((star) => {
                         star.addEventListener("click", function () {
                              const value = parseInt(this.getAttribute("data-value"));
                              const parent = this.parentElement;
                              const stars = parent.querySelectorAll(".rating-star");

                              stars.forEach((s) => s.classList.remove("selected"));
                              stars.forEach((s, index) => {
                                   if (index < value) s.classList.add("selected");
                              });

                              parent.querySelector('input[name="rating"]').value = value;
                         });
                    });
               });

               // 🖼 Preview ảnh upload
               function previewImages(input) {
                    const container = input.nextElementSibling;
                    container.innerHTML = "";
                    const files = input.files;
                    if (files.length > 5) {
                         alert("Chỉ được chọn tối đa 5 ảnh!");
                         input.value = "";
                         return;
                    }
                    Array.from(files).forEach((file) => {
                         if (!file.type.startsWith("image/")) return;
                         const reader = new FileReader();
                         reader.onload = (e) => {
                              const img = document.createElement("img");
                              img.src = e.target.result;
                              img.classList.add("preview-img");
                              container.appendChild(img);
                         };
                         reader.readAsDataURL(file);
                    });
               }
          </script>
     </body>
</html>
