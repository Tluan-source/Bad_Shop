<!DOCTYPE html>
<html
     xmlns:th="http://www.thymeleaf.org"
     xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
>
     <head th:replace="~{fragments/head :: head}">
          <title>Chi tiết cửa hàng - Admin</title>
     </head>
     <body class="admin-page">
          <div th:replace="~{fragments/header-admin :: header-admin}"></div>

          <div class="container-fluid mt-4 px-4">
               <div class="admin-content">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                         <h3><i class="fas fa-store text-primary me-2"></i>Chi tiết cửa hàng</h3>
                         <a th:href="@{/admin/stores}" class="btn btn-secondary">
                              <i class="fas fa-arrow-left me-2"></i>Quay lại
                         </a>
                    </div>

                    <!-- Store Info Card -->
                    <div class="row g-4 mb-4">
                         <div class="col-lg-4">
                              <div class="card border-0 shadow-sm">
                                   <div class="card-body text-center">
                                        <div class="mb-3">
                                             <i class="fas fa-store fa-5x text-primary"></i>
                                        </div>
                                        <h4 th:text="${store.name}">Tên cửa hàng</h4>
                                        <span
                                             class="badge-admin badge-lg"
                                             th:classappend="${store.isActive ? 'bg-success' : 'bg-danger'}"
                                             th:text="${store.isActive ? 'Đang hoạt động' : 'Không hoạt động'}"
                                             >Active</span
                                        >

                                        <div class="mt-4">
                                             <div class="d-flex justify-content-between mb-2">
                                                  <span class="text-muted">Rating:</span>
                                                  <strong class="text-warning">
                                                       <i class="fas fa-star"></i>
                                                       <span th:text="${store.rating}">4.8</span>/5
                                                  </strong>
                                             </div>
                                             <div class="d-flex justify-content-between mb-2">
                                                  <span class="text-muted">Point:</span>
                                                  <strong th:text="${store.point}">100</strong>
                                             </div>
                                             <div class="d-flex justify-content-between">
                                                  <span class="text-muted">E-Wallet:</span>
                                                  <strong
                                                       class="text-success"
                                                       th:text="${#numbers.formatCurrency(store.eWallet)}"
                                                       >5,000,000 VNĐ</strong
                                                  >
                                             </div>
                                        </div>

                                        <hr class="my-4" />

                                        <div class="d-grid gap-2">
                                             <form
                                                  th:action="@{/admin/stores/{id}/toggle-status(id=${store.id})}"
                                                  method="post"
                                             >
                                                  <button
                                                       type="submit"
                                                       class="btn btn-warning w-100"
                                                       th:text="${store.isActive ? 'Vô hiệu hóa cửa hàng' : 'Kích hoạt cửa hàng'}"
                                                  >
                                                       Toggle Status
                                                  </button>
                                             </form>
                                             <button
                                                  class="btn btn-danger"
                                                  th:attr="data-store-name=${store.name}, data-store-id=${store.id}"
                                                  onclick="confirmDeleteStore(this.getAttribute('data-store-name'), this.getAttribute('data-store-id'))"
                                             >
                                                  <i class="fas fa-trash me-2"></i>Xóa cửa hàng
                                             </button>
                                        </div>
                                   </div>
                              </div>
                         </div>

                         <div class="col-lg-8">
                              <div class="card border-0 shadow-sm mb-4">
                                   <div class="card-body">
                                        <h5 class="card-title mb-4">
                                             <i class="fas fa-info-circle text-primary me-2"></i
                                             >Thông tin cửa hàng
                                        </h5>

                                        <div class="row">
                                             <div class="col-md-6 mb-3">
                                                  <label class="text-muted small"
                                                       >ID Cửa hàng</label
                                                  >
                                                  <div class="fw-bold" th:text="${store.id}">
                                                       ST001
                                                  </div>
                                             </div>
                                             <div class="col-md-6 mb-3">
                                                  <label class="text-muted small">Slug (URL)</label>
                                                  <div class="fw-bold" th:text="${store.slug}">
                                                       store-slug
                                                  </div>
                                             </div>
                                             <div class="col-md-6 mb-3">
                                                  <label class="text-muted small"
                                                       >Chủ cửa hàng</label
                                                  >
                                                  <div class="fw-bold">
                                                       <i
                                                            class="fas fa-user-circle text-primary me-1"
                                                       ></i>
                                                       <span th:text="${store.owner.fullName}"
                                                            >Tên chủ</span
                                                       >
                                                  </div>
                                             </div>
                                             <div class="col-md-6 mb-3">
                                                  <label class="text-muted small">Email</label>
                                                  <div
                                                       class="fw-bold"
                                                       th:text="${store.owner.email}"
                                                  >
                                                       email@example.com
                                                  </div>
                                             </div>
                                             <div class="col-md-6 mb-3">
                                                  <label class="text-muted small"
                                                       >Số điện thoại</label
                                                  >
                                                  <div
                                                       class="fw-bold"
                                                       th:text="${store.owner.phone}"
                                                  >
                                                       0901234567
                                                  </div>
                                             </div>
                                             <div class="col-md-6 mb-3">
                                                  <label class="text-muted small">Commission</label>
                                                  <div class="fw-bold">
                                                       <span
                                                            th:if="${store.commission != null}"
                                                            th:text="${store.commission.name + ' (' + store.commission.feePercent + '%)'}"
                                                            >..</span
                                                       >
                                                       <span
                                                            th:unless="${store.commission != null}"
                                                            class="text-muted"
                                                            >Chưa thiết lập</span
                                                       >
                                                  </div>
                                             </div>
                                             <div class="col-12 mb-3">
                                                  <label class="text-muted small">Địa chỉ đầy đủ</label>
                                                  <div class="fw-bold">
                                                       <i class="fas fa-map-marker-alt text-danger me-2"></i>
                                                       <span th:if="${store.address != null}" th:text="${store.address}"></span>
                                                       <span th:if="${store.ward != null && !#strings.isEmpty(store.ward)}" th:text="${', ' + store.ward}"></span>
                                                       <span th:if="${store.district != null && !#strings.isEmpty(store.district)}" th:text="${', ' + store.district}"></span>
                                                       <span th:if="${store.city != null && !#strings.isEmpty(store.city)}" th:text="${', ' + store.city}"></span>
                                                  </div>
                                             </div>

                                             <div class="col-md-6 mb-3">
                                                  <label class="text-muted small">Vĩ độ (Latitude)</label>
                                                  <div class="fw-bold" th:text="${store.latitude}">10.762622</div>
                                             </div>

                                             <div class="col-md-6 mb-3">
                                                  <label class="text-muted small">Kinh độ (Longitude)</label>
                                                  <div class="fw-bold" th:text="${store.longitude}">106.660172</div>
                                             </div>
                                             
                                             <div class="col-12 mb-3">
                                                  <label class="text-muted small">Mô tả</label>
                                                  <div class="p-3 bg-light rounded" th:text="${#strings.contains(store.bio, '---') ? #strings.trim(#strings.substringBefore(store.bio, '---')) : store.bio}">Mô tả cửa hàng</div>
                                             </div>
                                             <div class="col-md-6 mb-3">
                                                  <label class="text-muted small">Ngày tạo</label>
                                                  <div
                                                       th:if="${store.createdAt != null}"
                                                       th:text="${#temporals.format(store.createdAt, 'dd/MM/yyyy HH:mm')}"
                                                  >
                                                       01/01/2024
                                                  </div>
                                             </div>
                                             <div class="col-md-6 mb-3">
                                                  <label class="text-muted small"
                                                       >Cập nhật lần cuối</label
                                                  >
                                                  <div
                                                       th:if="${store.updatedAt != null}"
                                                       th:text="${#temporals.format(store.updatedAt, 'dd/MM/yyyy HH:mm')}"
                                                  >
                                                       01/01/2024
                                                  </div>
                                             </div>
                                        </div>
                                   </div>
                              </div>

                              <!-- Statistics -->
                              <div class="row g-3">
                                   <div class="col-md-4">
                                        <div class="mini-stat-card text-center">
                                             <i class="fas fa-box fa-3x text-primary mb-2"></i>
                                             <h4 th:text="${productCount}">0</h4>
                                             <p class="text-muted mb-0">Sản phẩm</p>
                                        </div>
                                   </div>
                                   <div class="col-md-4">
                                        <div class="mini-stat-card text-center">
                                             <i
                                                  class="fas fa-shopping-cart fa-3x text-success mb-2"
                                             ></i>
                                             <h4 th:text="${orderCount}">0</h4>
                                             <p class="text-muted mb-0">Đơn hàng</p>
                                        </div>
                                   </div>
                                   <div class="col-md-4">
                                        <div class="mini-stat-card text-center">
                                             <i
                                                  class="fas fa-dollar-sign fa-3x text-warning mb-2"
                                             ></i>
                                             <h4>
                                                  <span
                                                       th:text="${#numbers.formatDecimal(totalRevenue, 0, 'COMMA', 0, 'POINT')}"
                                                       >0</span
                                                  >đ
                                             </h4>
                                             <p class="text-muted mb-0">Doanh thu</p>
                                        </div>
                                   </div>
                              </div>
                         </div>
                    </div>

                    <!-- Products List -->
                    <div class="card border-0 shadow-sm">
                         <div class="card-body">
                              <h5 class="card-title mb-4">
                                   <i class="fas fa-box text-primary me-2"></i>Sản phẩm của cửa hàng
                              </h5>

                              <div
                                   th:if="${products == null or products.isEmpty()}"
                                   class="text-center text-muted py-5"
                              >
                                   <i class="fas fa-box-open fa-3x mb-3"></i>
                                   <p>Chưa có sản phẩm nào</p>
                              </div>

                              <div
                                   th:unless="${products == null or products.isEmpty()}"
                                   class="table-responsive"
                              >
                                   <table class="table table-hover">
                                        <thead>
                                             <tr>
                                                  <th>Sản phẩm</th>
                                                  <th>Danh mục</th>
                                                  <th>Giá</th>
                                                  <th>Tồn kho</th>
                                                  <th>Đã bán</th>
                                                  <th>Trạng thái</th>
                                             </tr>
                                        </thead>
                                        <tbody>
                                             <tr th:each="product : ${products}">
                                                  <td>
                                                       <div class="d-flex align-items-center">
                                                            <i
                                                                 class="fas fa-box text-primary me-2"
                                                            ></i>
                                                            <span th:text="${product.name}"
                                                                 >Tên sản phẩm</span
                                                            >
                                                       </div>
                                                  </td>
                                                  <td
                                                       th:text="${product.category != null ? product.category.name : 'N/A'}"
                                                  >
                                                       Danh mục
                                                  </td>
                                                  <td>
                                                       <strong
                                                            th:text="${#numbers.formatCurrency(product.price)}"
                                                            >0 VNĐ</strong
                                                       >
                                                       <div
                                                            th:if="${product.promotionalPrice != null}"
                                                            class="small text-success"
                                                       >
                                                            KM:
                                                            <span
                                                                 th:text="${#numbers.formatCurrency(product.promotionalPrice)}"
                                                                 >0</span
                                                            >
                                                       </div>
                                                  </td>
                                                  <td>
                                                       <span
                                                            class="badge-admin"
                                                            th:classappend="${product.quantity > 10 ? 'bg-success' : (product.quantity > 0 ? 'bg-warning' : 'bg-danger')}"
                                                            th:text="${product.quantity}"
                                                            >0</span
                                                       >
                                                  </td>
                                                  <td th:text="${product.sold}">0</td>
                                                  <td>
                                                       <span
                                                            class="badge-admin"
                                                            th:classappend="${product.isActive ? 'bg-success' : 'bg-secondary'}"
                                                            th:text="${product.isActive ? 'Active' : 'Inactive'}"
                                                            >Active</span
                                                       >
                                                  </td>
                                             </tr>
                                        </tbody>
                                   </table>
                              </div>
                         </div>
                    </div>
               </div>
          </div>

          <div th:replace="~{fragments/footer-admin :: footer-admin}"></div>
          <link rel="stylesheet" th:href="@{/css/admin-style.css}" />

          <script>
               function confirmDeleteStore(storeName, storeId) {
                    if (
                         confirm(
                              'Bạn có chắc chắn muốn xóa cửa hàng "' +
                                   storeName +
                                   '"?\nLưu ý: Tất cả sản phẩm và đơn hàng liên quan sẽ bị ảnh hưởng!'
                         )
                    ) {
                         const form = document.createElement("form");
                         form.method = "POST";
                         form.action = "/admin/stores/" + storeId + "/delete";

                         const csrfToken = document.querySelector('meta[name="_csrf"]');
                         if (csrfToken) {
                              const csrfInput = document.createElement("input");
                              csrfInput.type = "hidden";
                              csrfInput.name = "_csrf";
                              csrfInput.value = csrfToken.getAttribute("content");
                              form.appendChild(csrfInput);
                         }

                         document.body.appendChild(form);
                         form.submit();
                    }
               }
          </script>
     </body>
</html>
