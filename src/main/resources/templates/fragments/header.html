<!DOCTYPE html>
<html
     xmlns:th="http://www.thymeleaf.org"
     xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
     <head>
          <title>Header Fragment</title>
     </head>
     <body>
          <header th:fragment="header">
               <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
                    <div class="container">
                         <a class="navbar-brand d-flex align-items-center" th:href="@{/}">
                              <i class="fas fa-badminton fa-lg me-2"></i>
                              <span>Badminton Marketplace</span>
                         </a>

                         <button
                              class="navbar-toggler"
                              type="button"
                              data-bs-toggle="collapse"
                              data-bs-target="#navbarNav"
                         >
                              <span class="navbar-toggler-icon"></span>
                         </button>

                         <div class="collapse navbar-collapse" id="navbarNav">
                              <ul class="navbar-nav me-auto">
                                   <li class="nav-item">
                                        <a class="nav-link" th:href="@{/}">Trang chủ</a>
                                   </li>
                                   <li class="nav-item">
                                        <a class="nav-link" th:href="@{/products}">Sản phẩm</a>
                                   </li>
                                   <li class="nav-item">
                                        <a class="nav-link" th:href="@{/stores}">Cửa hàng</a>
                                   </li>
                                   <li class="nav-item">
                                        <a class="nav-link" th:href="@{/categories}">Danh mục</a>
                                   </li>
                              </ul>

                              <ul class="navbar-nav">
                                   <!-- Cart -->
                                   <li class="nav-item me-2" sec:authorize="isAuthenticated()">
                                        <a
                                             class="nav-link d-flex align-items-center position-relative"
                                             th:href="@{/cart}"
                                        >
                                             <i class="fas fa-shopping-cart fa-lg"></i>
                                             <span
                                                  class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger cart-count"
                                                  style="font-size: 0.7rem"
                                             >
                                                  0
                                             </span>
                                        </a>
                                   </li>

                                   <!-- Favorites -->
                                   <li class="nav-item me-2" sec:authorize="isAuthenticated()">
                                        <a
                                             class="nav-link d-flex align-items-center position-relative"
                                             th:href="@{/favorites}"
                                        >
                                             <i class="fas fa-heart fa-lg"></i>
                                             <span
                                                  class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger favorite-count"
                                                  style="font-size: 0.7rem"
                                             >
                                                  0
                                             </span>
                                        </a>
                                   </li>

                                   <!-- Cart for guest -->
                                   <li class="nav-item me-2" sec:authorize="!isAuthenticated()">
                                        <a
                                             class="nav-link d-flex align-items-center"
                                             th:href="@{/login}"
                                        >
                                             <i class="fas fa-shopping-cart fa-lg me-1"></i>
                                             Giỏ hàng
                                        </a>
                                   </li>

                                   <!-- Menu khi đã đăng nhập -->
                                   <li class="nav-item dropdown" sec:authorize="isAuthenticated()">
                                        <a
                                             class="nav-link dropdown-toggle d-flex align-items-center"
                                             href="#"
                                             id="accountDropdown"
                                             role="button"
                                             data-bs-toggle="dropdown"
                                             aria-expanded="false"
                                        >
                                             <i class="fas fa-user-circle me-1"></i>
                                             <span sec:authentication="name">Tài khoản</span>
                                        </a>
                                        <ul
                                             class="dropdown-menu dropdown-menu-end"
                                             aria-labelledby="accountDropdown"
                                        >
                                             <li>
                                                  <h6 class="dropdown-header">
                                                       <i class="fas fa-user"></i>
                                                       <span sec:authentication="name"></span>
                                                  </h6>
                                             </li>
                                             <li><hr class="dropdown-divider" /></li>
                                             <li>
                                                  <a
                                                       class="dropdown-item"
                                                       th:href="@{/user/profile}"
                                                  >
                                                       <i class="fas fa-id-card me-2"></i>Thông tin
                                                       tài khoản
                                                  </a>
                                             </li>
                                             <li>
                                                  <a class="dropdown-item" th:href="@{/favorites}">
                                                       <i class="fas fa-heart me-2"></i>Sản phẩm yêu
                                                       thích
                                                  </a>
                                             </li>
                                             <li>
                                                  <a class="dropdown-item" th:href="@{/cart}">
                                                       <i class="fas fa-shopping-cart me-2"></i>Giỏ
                                                       hàng
                                                  </a>
                                             </li>
                                             <li>
                                                  <a class="dropdown-item" th:href="@{/orders}">
                                                       <i class="fas fa-shopping-bag me-2"></i>Đơn
                                                       hàng của tôi
                                                  </a>
                                             </li>
                                             <li><hr class="dropdown-divider" /></li>
                                             <li>
                                                  <form
                                                       th:action="@{/logout}"
                                                       method="post"
                                                       class="d-inline w-100"
                                                  >
                                                       <button
                                                            type="submit"
                                                            class="dropdown-item text-danger"
                                                       >
                                                            <i class="fas fa-sign-out-alt me-2"></i
                                                            >Đăng xuất
                                                       </button>
                                                  </form>
                                             </li>
                                        </ul>
                                   </li>

                                   <!-- Nút đăng nhập khi chưa đăng nhập -->
                                   <li class="nav-item" sec:authorize="!isAuthenticated()">
                                        <a class="nav-link" th:href="@{/login}">
                                             <i class="fas fa-sign-in-alt me-1"></i>Đăng nhập
                                        </a>
                                   </li>
                              </ul>
                         </div>
                    </div>
               </nav>

               <!-- Script to update cart and favorite counts -->
               <script sec:authorize="isAuthenticated()">
                    document.addEventListener("DOMContentLoaded", function () {
                         // Update cart count
                         fetch("/cart/count")
                              .then((response) => response.json())
                              .then((data) => {
                                   const cartBadge = document.querySelector(".cart-count");
                                   if (cartBadge && data.count !== undefined) {
                                        cartBadge.textContent = data.count;
                                        if (data.count === 0) {
                                             cartBadge.style.display = "none";
                                        }
                                   }
                              })
                              .catch((error) => console.error("Error fetching cart count:", error));

                         // Update favorite count
                         fetch("/favorites/count")
                              .then((response) => response.json())
                              .then((data) => {
                                   const favBadge = document.querySelector(".favorite-count");
                                   if (favBadge && data.count !== undefined) {
                                        favBadge.textContent = data.count;
                                        if (data.count === 0) {
                                             favBadge.style.display = "none";
                                        }
                                   }
                              })
                              .catch((error) =>
                                   console.error("Error fetching favorite count:", error)
                              );
                    });
               </script>
          </header>
     </body>
</html>
