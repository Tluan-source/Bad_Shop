<!DOCTYPE html>
<html
     xmlns:th="http://www.thymeleaf.org"
     xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
>
     <head>
          <title>Header Fragment</title>
     </head>
     <body>
          <header th:fragment="header">
               <style>
                    /* üî• Fix dropdown b·ªã che b·ªüi sticky-top (cart summary) */
                    .navbar .dropdown-menu {
                         z-index: 3000 !important;
                    }

                    /* N·∫øu mu·ªën ƒë·∫£m b·∫£o overlay ƒë·∫πp h∆°n */
                    .navbar .dropdown-menu.show {
                         position: absolute !important;
                    }
               </style>
               <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
                    <div class="container">
                         <a class="navbar-brand d-flex align-items-center" th:href="@{/}">
                              <i class="fas fa-badminton fa-lg me-2"></i>
                              <span>Bad Shop</span>
                         </a>

                         <button
                              class="navbar-toggler"
                              type="button"
                              data-bs-toggle="collapse"
                              data-bs-target="#navbarNav"
                         >
                              <span class="navbar-toggler-icon"></span>
                         </button>

                         <div class="collapse navbar-collapse" id="navbarNav">
                              <ul class="navbar-nav me-auto">
                                   <li class="nav-item">
                                        <a class="nav-link" th:href="@{/}">Trang ch·ªß</a>
                                   </li>
                                   <li class="nav-item">
                                        <a class="nav-link" th:href="@{/products}">S·∫£n ph·∫©m</a>
                                   </li>
                                   <li class="nav-item">
                                        <a class="nav-link" th:href="@{/stores}">C·ª≠a h√†ng</a>
                                   </li>
                                   <li class="nav-item">
                                        <a class="nav-link" th:href="@{/categories}">Danh m·ª•c</a>
                                   </li>
                              </ul>

                              <ul class="navbar-nav">
                                   <!-- Cart -->
                                   <li class="nav-item me-2" sec:authorize="isAuthenticated()">
                                        <a
                                             class="nav-link d-flex align-items-center position-relative"
                                             th:href="@{/cart}"
                                             style="position: relative; top: 13px"
                                        >
                                             <i class="fas fa-shopping-cart fa-lg"></i>
                                             <span
                                                  class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger cart-count"
                                                  style="font-size: 0.7rem"
                                             >
                                                  0
                                             </span>
                                        </a>
                                   </li>

                                   <!-- Favorites -->
                                   <li class="nav-item me-2" sec:authorize="isAuthenticated()">
                                        <a
                                             class="nav-link d-flex align-items-center position-relative"
                                             th:href="@{/favorites}"
                                             style="position: relative; top: 13px"
                                        >
                                             <i class="fas fa-heart fa-lg"></i>
                                             <span
                                                  class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger favorite-count"
                                                  style="font-size: 0.7rem"
                                             >
                                                  0
                                             </span>
                                        </a>
                                   </li>

                                   <!-- Notification Bell -->
                                   <li
                                        class="nav-item dropdown me-2"
                                        sec:authorize="isAuthenticated()"
                                   >
                                        <a
                                             class="nav-link d-flex align-items-center position-relative"
                                             href="#"
                                             id="notificationDropdown"
                                             role="button"
                                             data-bs-toggle="dropdown"
                                             aria-expanded="false"
                                             style="position: relative; top: 13px"
                                        >
                                             <i class="fas fa-bell fa-lg"></i>
                                             <span
                                                  id="notificationBadge"
                                                  class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                                                  style="display: none; font-size: 0.7rem"
                                             >
                                                  0
                                             </span>
                                        </a>
                                        <div
                                             class="dropdown-menu dropdown-menu-end shadow"
                                             aria-labelledby="notificationDropdown"
                                             style="
                                                  width: 350px;
                                                  max-height: 500px;
                                                  overflow-y: auto;
                                             "
                                        >
                                             <div
                                                  class="d-flex justify-content-between align-items-center px-3 py-2 border-bottom"
                                             >
                                                  <h6 class="mb-0">Th√¥ng b√°o</h6>
                                                  <button
                                                       id="markAllReadBtn"
                                                       class="btn btn-sm btn-link text-primary p-0"
                                                  >
                                                       ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc
                                                  </button>
                                             </div>
                                             <div
                                                  id="notificationList"
                                                  class="list-group list-group-flush"
                                             >
                                                  <div class="text-center py-4 text-muted">
                                                       <i class="fas fa-bell-slash fa-2x mb-2"></i>
                                                       <p class="mb-0">Kh√¥ng c√≥ th√¥ng b√°o m·ªõi</p>
                                                  </div>
                                             </div>
                                             <div class="text-center border-top p-2">
                                                  <a
                                                       th:href="@{/notifications}"
                                                       class="btn btn-sm btn-link"
                                                       >Xem t·∫•t c·∫£</a
                                                  >
                                             </div>
                                        </div>
                                   </li>

                                   <!-- Cart for guest -->
                                   <li class="nav-item me-2" sec:authorize="!isAuthenticated()">
                                        <a
                                             class="nav-link d-flex align-items-center"
                                             th:href="@{/login}"
                                        >
                                             <i class="fas fa-shopping-cart fa-lg me-1"></i>
                                             Gi·ªè h√†ng
                                        </a>
                                   </li>

                                   <!-- Menu khi ƒë√£ ƒëƒÉng nh·∫≠p -->
                                   <li class="nav-item dropdown" sec:authorize="isAuthenticated()">
                                        <a
                                             class="nav-link dropdown-toggle d-flex align-items-center"
                                             href="#"
                                             id="accountDropdown"
                                             role="button"
                                             data-bs-toggle="dropdown"
                                             aria-expanded="false"
                                        >
                                             <img
                                                  th:if="${currentUser != null and currentUser.avatar != null and !#strings.isEmpty(currentUser.avatar)}"
                                                  th:src="${currentUser.avatar}"
                                                  alt="Avatar"
                                                  class="rounded-circle me-2"
                                                  style="
                                                       width: 32px;
                                                       height: 32px;
                                                       object-fit: cover;
                                                       border: 2px solid rgba(255, 255, 255, 0.3);
                                                  "
                                             />
                                             <img
                                                  th:if="${currentUser == null or currentUser.avatar == null or #strings.isEmpty(currentUser.avatar)}"
                                                  src="/images/default-avatar.png"
                                                  alt="Avatar"
                                                  class="rounded-circle me-2"
                                                  style="
                                                       width: 32px;
                                                       height: 32px;
                                                       object-fit: cover;
                                                       border: 2px solid rgba(255, 255, 255, 0.3);
                                                  "
                                             />
                                             <span
                                                  th:if="${currentUser != null and currentUser.fullName != null}"
                                                  th:text="${currentUser.fullName}"
                                                  >T√†i kho·∫£n</span
                                             >
                                             <span
                                                  th:if="${currentUser == null or currentUser.fullName == null}"
                                                  sec:authentication="name"
                                                  >T√†i kho·∫£n</span
                                             >
                                        </a>
                                        <ul
                                             class="dropdown-menu dropdown-menu-end"
                                             aria-labelledby="accountDropdown"
                                        >
                                             <li>
                                                  <div
                                                       class="dropdown-header d-flex align-items-center"
                                                  >
                                                       <img
                                                            th:if="${currentUser != null and currentUser.avatar != null and !#strings.isEmpty(currentUser.avatar)}"
                                                            th:src="${currentUser.avatar}"
                                                            alt="Avatar"
                                                            class="rounded-circle me-2"
                                                            style="
                                                                 width: 40px;
                                                                 height: 40px;
                                                                 object-fit: cover;
                                                            "
                                                       />
                                                       <img
                                                            th:if="${currentUser == null or currentUser.avatar == null or #strings.isEmpty(currentUser.avatar)}"
                                                            src="/images/default-avatar.png"
                                                            alt="Avatar"
                                                            class="rounded-circle me-2"
                                                            style="
                                                                 width: 40px;
                                                                 height: 40px;
                                                                 object-fit: cover;
                                                            "
                                                       />
                                                       <div>
                                                            <div
                                                                 class="fw-bold"
                                                                 th:if="${currentUser != null and currentUser.fullName != null}"
                                                                 th:text="${currentUser.fullName}"
                                                            ></div>
                                                            <div
                                                                 class="fw-bold"
                                                                 th:if="${currentUser == null or currentUser.fullName == null}"
                                                                 sec:authentication="name"
                                                            ></div>
                                                            <small
                                                                 class="text-muted"
                                                                 th:if="${currentUser != null and currentUser.email != null}"
                                                                 th:text="${currentUser.email}"
                                                            ></small>
                                                            <small
                                                                 class="text-muted"
                                                                 th:if="${currentUser == null or currentUser.email == null}"
                                                                 sec:authentication="name"
                                                            ></small>
                                                       </div>
                                                  </div>
                                             </li>
                                             <li><hr class="dropdown-divider" /></li>

                                             <!-- User Menu Items -->
                                             <li>
                                                  <a
                                                       class="dropdown-item"
                                                       th:href="@{/user/profile}"
                                                  >
                                                       <i class="fas fa-id-card me-2"></i>Th√¥ng tin
                                                       t√†i kho·∫£n
                                                  </a>
                                             </li>
                                             <li>
                                                  <a class="dropdown-item" th:href="@{/favorites}">
                                                       <i class="fas fa-heart me-2"></i>S·∫£n ph·∫©m y√™u
                                                       th√≠ch
                                                  </a>
                                             </li>
                                             <li>
                                                  <a class="dropdown-item" th:href="@{/cart}">
                                                       <i class="fas fa-shopping-cart me-2"></i>Gi·ªè
                                                       h√†ng
                                                  </a>
                                             </li>
                                             <li>
                                                  <a class="dropdown-item" th:href="@{/orders}">
                                                       <i class="fas fa-shopping-bag me-2"></i>ƒê∆°n
                                                       h√†ng c·ªßa t√¥i
                                                  </a>
                                             </li>
                                             <li sec:authorize="!hasRole('ADMIN')">
                                                  <a class="dropdown-item" th:href="@{/user/chat}">
                                                       <i class="fas fa-comments me-2"></i>Tin nh·∫Øn
                                                  </a>
                                             </li>
                                             <li><hr class="dropdown-divider" /></li>

                                             <!-- Vendor/Shop Management Menu - Ch·ªâ hi·ªÉn th·ªã khi store active -->
                                             <th:block
                                                  sec:authorize="hasAnyRole('VENDOR', 'ADMIN')"
                                                  th:if="${isStoreActive}"
                                             >
                                                  <li>
                                                       <h6 class="dropdown-header text-primary">
                                                            <i class="fas fa-store"></i>
                                                            Qu·∫£n l√Ω Shop
                                                       </h6>
                                                  </li>
                                                  <li>
                                                       <a
                                                            class="dropdown-item"
                                                            th:href="@{/vendor/dashboard}"
                                                       >
                                                            <i
                                                                 class="fas fa-tachometer-alt me-2"
                                                            ></i
                                                            >Trang qu·∫£n l√Ω Shop
                                                       </a>
                                                  </li>
                                                  <li>
                                                       <a
                                                            class="dropdown-item"
                                                            th:href="@{/vendor/store}"
                                                       >
                                                            <i class="fas fa-cog me-2"></i>Th√¥ng tin
                                                            Shop
                                                       </a>
                                                  </li>
                                                  <li>
                                                       <a
                                                            class="dropdown-item"
                                                            th:href="@{/vendor/products}"
                                                       >
                                                            <i class="fas fa-box me-2"></i>S·∫£n ph·∫©m
                                                            c·ªßa t√¥i
                                                       </a>
                                                  </li>
                                                  <li>
                                                       <a
                                                            class="dropdown-item"
                                                            th:href="@{/vendor/orders}"
                                                       >
                                                            <i class="fas fa-shopping-cart me-2"></i
                                                            >ƒê∆°n h√†ng Shop
                                                       </a>
                                                  </li>
                                                  <li>
                                                       <a
                                                            class="dropdown-item"
                                                            th:href="@{/vendor/promotions}"
                                                       >
                                                            <i class="fas fa-tags me-2"></i>Khuy·∫øn
                                                            m√£i
                                                       </a>
                                                  </li>
                                                  <li>
                                                       <a
                                                            class="dropdown-item"
                                                            th:href="@{/vendor/analytics}"
                                                       >
                                                            <i class="fas fa-chart-line me-2"></i
                                                            >Doanh thu
                                                       </a>
                                                  </li>

                                                  <li><hr class="dropdown-divider" /></li>
                                             </th:block>

                                             <!-- ƒêƒÉng k√Ω l√†m ng∆∞·ªùi b√°n - Ch·ªâ hi·ªÉn th·ªã khi ch∆∞a c√≥ role VENDOR -->
                                             <li sec:authorize="!hasRole('VENDOR')">
                                                  <a
                                                       class="dropdown-item"
                                                       th:href="@{/vendor/register}"
                                                  >
                                                       <i class="fas fa-store-alt me-2"></i>ƒêƒÉng k√Ω
                                                       l√†m ng∆∞·ªùi b√°n
                                                  </a>
                                             </li>

                                             <li><hr class="dropdown-divider" /></li>
                                             <li>
                                                  <form
                                                       th:action="@{/logout}"
                                                       method="post"
                                                       class="d-inline w-100"
                                                  >
                                                       <button
                                                            type="submit"
                                                            class="dropdown-item text-danger"
                                                       >
                                                            <i class="fas fa-sign-out-alt me-2"></i
                                                            >ƒêƒÉng xu·∫•t
                                                       </button>
                                                  </form>
                                             </li>
                                        </ul>
                                   </li>

                                   <!-- N√∫t ƒëƒÉng nh·∫≠p khi ch∆∞a ƒëƒÉng nh·∫≠p -->
                                   <li class="nav-item" sec:authorize="!isAuthenticated()">
                                        <a class="nav-link" th:href="@{/login}">
                                             <i class="fas fa-sign-in-alt me-1"></i>ƒêƒÉng nh·∫≠p
                                        </a>
                                   </li>
                              </ul>
                         </div>
                    </div>
               </nav>

               <!-- Script to update cart and favorite counts -->
               <script sec:authorize="isAuthenticated()">
                    document.addEventListener("DOMContentLoaded", function () {
                         // Update cart count
                         fetch("/cart/count")
                              .then((response) => response.json())
                              .then((data) => {
                                   const cartBadge = document.querySelector(".cart-count");
                                   if (cartBadge && data.count !== undefined) {
                                        cartBadge.textContent = data.count;
                                        if (data.count === 0) {
                                             cartBadge.style.display = "none";
                                        }
                                   }
                              })
                              .catch((error) => console.error("Error fetching cart count:", error));

                         // Update favorite count
                         fetch("/favorites/count")
                              .then((response) => response.json())
                              .then((data) => {
                                   const favBadge = document.querySelector(".favorite-count");
                                   if (favBadge && data.count !== undefined) {
                                        favBadge.textContent = data.count;
                                        if (data.count === 0) {
                                             favBadge.style.display = "none";
                                        }
                                   }
                              })
                              .catch((error) =>
                                   console.error("Error fetching favorite count:", error)
                              );

                         // Load notification count
                         loadNotificationCount();

                         // Load notifications when dropdown is opened
                         const notificationDropdown =
                              document.getElementById("notificationDropdown");
                         if (notificationDropdown) {
                              notificationDropdown.addEventListener("click", function () {
                                   loadRecentNotifications();
                              });
                         }

                         // Mark all as read button
                         const markAllReadBtn = document.getElementById("markAllReadBtn");
                         if (markAllReadBtn) {
                              markAllReadBtn.addEventListener("click", function (e) {
                                   e.preventDefault();
                                   markAllNotificationsRead();
                              });
                         }
                    });

                    function loadNotificationCount() {
                         fetch("/notifications/count")
                              .then((response) => response.json())
                              .then((data) => {
                                   updateBadge(data.count);
                              })
                              .catch((error) =>
                                   console.error("Error loading notification count:", error)
                              );
                    }

                    function loadRecentNotifications() {
                         fetch("/notifications/recent")
                              .then((response) => response.json())
                              .then((data) => {
                                   displayNotifications(data.notifications);
                                   updateBadge(data.totalUnread);
                              })
                              .catch((error) =>
                                   console.error("Error loading notifications:", error)
                              );
                    }

                    function displayNotifications(notifications) {
                         const listContainer = document.getElementById("notificationList");

                         if (!notifications || notifications.length === 0) {
                              listContainer.innerHTML = `
                                   <div class="text-center py-4 text-muted">
                                        <i class="fas fa-bell-slash fa-2x mb-2"></i>
                                        <p class="mb-0">Kh√¥ng c√≥ th√¥ng b√°o m·ªõi</p>
                                   </div>`;
                              return;
                         }

                         listContainer.innerHTML = notifications
                              .map(
                                   (notif) => `
                              <a href="#" class="list-group-item list-group-item-action ${
                                   notif.isRead ? "" : "bg-light"
                              }" 
                                   onclick="markNotificationRead('${notif.id}', event)">
                                   <div class="d-flex w-100 justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                             <h6 class="mb-1">${getNotificationIcon(notif.type)} ${
                                        notif.title
                                   }</h6>
                                             <p class="mb-1 small text-muted">${notif.content}</p>
                                             <small class="text-muted">${formatDate(
                                                  notif.createdAt
                                             )}</small>
                                        </div>
                                        ${
                                             !notif.isRead
                                                  ? '<span class="badge bg-primary rounded-pill">M·ªõi</span>'
                                                  : ""
                                        }
                                   </div>
                              </a>
                         `
                              )
                              .join("");
                    }

                    function markNotificationRead(notificationId, event) {
                         event.preventDefault();

                         fetch(`/notifications/${notificationId}/read`, {
                              method: "POST",
                              headers: {
                                   "Content-Type": "application/json",
                              },
                         })
                              .then((response) => response.json())
                              .then((data) => {
                                   if (data.success) {
                                        updateBadge(data.unreadCount);
                                        // Redirect to notifications page
                                        window.location.href = "/notifications";
                                   }
                              })
                              .catch((error) =>
                                   console.error("Error marking notification as read:", error)
                              );
                    }

                    function markAllNotificationsRead() {
                         fetch("/notifications/read-all", {
                              method: "POST",
                              headers: {
                                   "Content-Type": "application/json",
                              },
                         })
                              .then((response) => response.json())
                              .then((data) => {
                                   if (data.success) {
                                        updateBadge(0);
                                        loadRecentNotifications();
                                   }
                              })
                              .catch((error) => console.error("Error marking all as read:", error));
                    }

                    function updateBadge(count) {
                         const badge = document.getElementById("notificationBadge");
                         if (badge) {
                              if (count > 0) {
                                   badge.textContent = count > 99 ? "99+" : count;
                                   badge.style.display = "inline";
                              } else {
                                   badge.style.display = "none";
                              }
                         }
                    }

                    function getNotificationIcon(type) {
                         const icons = {
                              ACCOUNT_LOCKED: '<i class="fas fa-user-lock text-danger"></i>',
                              STORE_LOCKED: '<i class="fas fa-store-slash text-danger"></i>',
                              PRODUCT_REJECTED: '<i class="fas fa-times-circle text-warning"></i>',
                              COMMENT_REMOVED: '<i class="fas fa-comment-slash text-warning"></i>',
                              ORDER_UPDATE: '<i class="fas fa-box text-info"></i>',
                              SYSTEM: '<i class="fas fa-info-circle text-primary"></i>',
                         };
                         return icons[type] || '<i class="fas fa-bell"></i>';
                    }

                    function formatDate(dateString) {
                         const date = new Date(dateString);
                         const now = new Date();
                         const diff = Math.floor((now - date) / 1000);

                         if (diff < 60) return "V·ª´a xong";
                         if (diff < 3600) return Math.floor(diff / 60) + " ph√∫t tr∆∞·ªõc";
                         if (diff < 86400) return Math.floor(diff / 3600) + " gi·ªù tr∆∞·ªõc";
                         if (diff < 604800) return Math.floor(diff / 86400) + " ng√†y tr∆∞·ªõc";

                         return date.toLocaleDateString("vi-VN");
                    }

                    // Auto refresh notification count every 30 seconds
                    setInterval(loadNotificationCount, 30000);
               </script>
          </header>
     </body>
</html>
